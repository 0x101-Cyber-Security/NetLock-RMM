@using MySqlConnector;
@using System.Data.Common;
@using System.Text.Json;
@using System.Security.Claims

@inject NavigationManager NavigationManager
@inject ILocalStorageService localStorage
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@inject IStringLocalizer<Layout.Agent_Download.Agent_Download_Dialog> Localizer
@inject AuthenticationStateProvider AuthenticationStateProvider

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h5">@Localizer["download_installer"]</MudText>
    </TitleContent>
    <DialogContent>

        @if (!creating_installer)
        {
            @if (agent_package_configurations_list.Count == 0)
            {
                <MudText Typo="Typo.h6">@Localizer["no_configurations"]</MudText>

                <MudButton Class="ml-2 mt-2" Size="Size.Small" Color="Color.Info" Variant="Variant.Filled" OnClick="Add_Agent_Configuration_Dialog">@Localizer["create_new_configuration"]</MudButton>
            }
            else
            {
                <MudButton Class="ml-2 mb-2" Size="Size.Small" Color="Color.Default" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add" OnClick="Add_Agent_Configuration_Dialog">@Localizer["create_new_configuration"]</MudButton>

                <MudSelect Class="mt-2" T="string" Label="Selected configuration" AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter" @bind-Value="name" @bind-Value:after="async () => { await Get_Configuration(name); }" Required="true" RequiredError="@Localizer["required"]" Disabled="creating_installer">
                    @{
                        foreach (var name in agent_package_configurations_list)
                        {
                            <MudSelectItem Value="@name" />
                        }
                    }
                </MudSelect>
            }

            if (!String.IsNullOrEmpty(name))
            {
                <MudTextField class="mt-2" Label="Name" T="string" @bind-Value="name" Required="true" RequiredError="@Localizer["required"]" Immediate="true" ReadOnly="false" />

                <MudCheckBox Class="mt-2 ml-2" T="bool" @bind-Value="@ssl" @bind-Value:after="Update_Ports" Label="SSL" Color="Color.Primary" />

                <div style="display: flex; align-items: center;">
                    <MudText Typo="Typo.h6">@Localizer["target_server"]</MudText>

                    <MudTooltip Text="@Localizer["text"]">
                        <MudIconButton Class="ml-2" Icon="@Icons.Material.Filled.Info" Variant="Variant.Text" Size="Size.Small" Color="Color.Default"></MudIconButton>
                    </MudTooltip>
                </div>
                
                if (Configuration.Members_Portal.IsCloudEnabled)
                {
                    <MudButton Class="mt-2 mb-3" OnClick="GetCloudPreset" Variant="Variant.Filled" Size="@Size.Small" Color="@Color.Info">Load cloud preset</MudButton>
                }

                <MudTextField Label="Communication Server" T="string" @bind-Value="communication_servers" @bind-Value:after="CleanInput" Required="true" RequiredError="@Localizer["required"]" Immediate="true" ReadOnly="false" />
                <MudTextField Label="Remote Server" T="string" @bind-Value="remote_servers" @bind-Value:after="CleanInput" Required="true" RequiredError="@Localizer["required"]" Immediate="true" ReadOnly="false" />
                <MudTextField Label="Update Server" T="string" @bind-Value="update_servers" @bind-Value:after="CleanInput" Required="true" RequiredError="@Localizer["required"]" Immediate="@true" ReadOnly="false" />
                <MudTextField Label="Trust Server" T="string" @bind-Value="trust_servers" @bind-Value:after="CleanInput" Required="true" RequiredError="@Localizer["required"]" Immediate="@true" ReadOnly="false" />
                <MudTextField Label="File Server" T="string" @bind-Value="file_servers" @bind-Value:after="CleanInput" Required="true" RequiredError="@Localizer["required"]" Immediate="@true" ReadOnly="false" />

                <MudSelect Class="mt-2" T="string" Label="@Localizer["tenant"]" AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter" @bind-Value="tenant_name" @bind-Value:after="async () => { await Get_Tenant_Id(tenant_name); }" Immediate="true" Required="true" RequiredError="@Localizer["required"]">
                    @{
                        foreach (var name in tenants_list)
                        {
                            <MudSelectItem Value="@name" />
                        }
                    }
                </MudSelect>

                <MudSelect Class="mt-2" T="string" Label="@Localizer["location"]" AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter" @bind-Value="location_name" @bind-Value:after="async () => { await Get_Location_Id(location_name); }" Immediate="true" Required="true" RequiredError="@Localizer["required"]">
                    @{
                        foreach (var name in locations_list)
                        {
                            <MudSelectItem Value="@name" />
                        }
                    }
                </MudSelect>

                <MudSelect Class="mt-2" T="string" Label="@Localizer["language"]" AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter" @bind-Value="language" Required="true" RequiredError="@Localizer["required"]">
                    <MudSelectItem Value="@("en-US")" />
                    <!--<MudSelectItem Value="@("de-DE")" />-->
                </MudSelect>

                <MudPaper Class="mt-2">
                    <MudText Typo="Typo.h6">@Localizer["download_installer"]</MudText>
                    <MudText Typo="Typo.body2">@Localizer["architecture_text"]</MudText>

                    <MudSelect Class="mt-2" T="string" Label="@Localizer["architecture selection"]" AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter" @bind-Value="architecture" Required="true" RequiredError="@Localizer["required"]" Disabled="creating_installer">
                        <MudSelectItem Value="@("win-x64")" />
                        <MudSelectItem Value="@("win-arm64")" />
                        <MudSelectItem Value="@("linux-x64")" />
                        <MudSelectItem Value="@("linux-arm64")" />
                        <MudSelectItem Value="@("osx-x64")" />
                        <MudSelectItem Value="@("osx-arm64")" />
                    </MudSelect>

                    <div style="display: flex; align-items: center;">
                        <MudButton Class="mt-2" OnClick="@Show_Digital_Signature_Warning" Variant="Variant.Filled" Size="@Size.Small" Color="@Color.Info" Disabled="@(String.IsNullOrEmpty(name) || String.IsNullOrEmpty(communication_servers) || String.IsNullOrEmpty(remote_servers) || String.IsNullOrEmpty(update_servers) || String.IsNullOrEmpty(trust_servers) || String.IsNullOrEmpty(tenant_name)|| String.IsNullOrEmpty(location_name) || creating_installer)">@Localizer["download_installer"]</MudButton>

                        <MudTooltip Text="Creates a custom installer with the selected configuration. Once created, a download link will be provided. Please note that this will break the digital signature of the installer and may trigger warnings from antivirus software when executing. However, the installed agent will be fully digital signed.">
                            <MudIconButton Class="ml-2 mt-2" Icon="@Icons.Material.Filled.Info" Variant="Variant.Text" Size="Size.Small" Color="Color.Default"></MudIconButton>
                        </MudTooltip>
                    </div>
                </MudPaper>
            }
        }

        @if (loading_overlay && creating_installer)
        {
            <MudText Typo="Typo.h6">
                @Localizer["your package is being created. This can take a while, please wait"]
            </MudText>

            <MudProgressLinear Class="mt-2" Color="Color.Info" Indeterminate="true"></MudProgressLinear>
        }

        @if (!String.IsNullOrEmpty(installer_url) && !creating_installer)
        {
            <MudText Class="mt-2" Typo="Typo.body1">Url: @installer_url</MudText>
            
            <div style="display: flex; align-items: center; margin-top: 10px; gap: 10px;">
                @if (architecture.StartsWith("win-"))
                {
                    <MudButton OnClick="@Download_Installation_Script_Windows" Variant="Variant.Filled" Size="@Size.Small" Color="@Color.Success">
                        Download Windows installation script (.ps1)
                    </MudButton>
                    
                    <MudTooltip Text="Downloads a PowerShell script that automatically downloads and installs the agent. The script checks if the NetLock RMM Agent is already installed and only performs the installation if it is not.">
                        <MudIconButton Icon="@Icons.Material.Filled.Info" Variant="Variant.Text" Size="Size.Small" Color="Color.Default"></MudIconButton>
                    </MudTooltip>
                }
                
                @if (architecture.StartsWith("linux-"))
                {
                    <MudButton OnClick="@Download_Installation_Script_Linux" Variant="Variant.Filled" Size="@Size.Small" Color="@Color.Success">
                        Download Linux installation script (.sh)
                    </MudButton>
                    
                    <MudTooltip Text="Downloads a Bash script that automatically downloads and installs the agent. The script checks if the NetLock RMM Agent service is already installed and only performs the installation if it is not.">
                        <MudIconButton Icon="@Icons.Material.Filled.Info" Variant="Variant.Text" Size="Size.Small" Color="Color.Default"></MudIconButton>
                    </MudTooltip>
                }
                
                @if (architecture.StartsWith("osx-"))
                {
                    <MudButton OnClick="@Download_Installation_Script_MacOS" Variant="Variant.Filled" Size="@Size.Small" Color="@Color.Success">
                        Download macOS installation script (.sh)
                    </MudButton>
                    
                    <MudTooltip Text="Downloads a Bash script that automatically downloads and installs the agent. The script checks if the NetLock RMM Agent service is already installed and only performs the installation if it is not.">
                        <MudIconButton Icon="@Icons.Material.Filled.Info" Variant="Variant.Text" Size="Size.Small" Color="Color.Default"></MudIconButton>
                    </MudTooltip>
                }
            </div>
        }

    </DialogContent>
    <DialogActions>

        @if (!String.IsNullOrEmpty(name) && !creating_installer)
        {
            <MudButton OnClick="Update_Configuration" Variant="Variant.Filled" Size="@Size.Small" Color="@Color.Success" Disabled="@(String.IsNullOrEmpty(name) || String.IsNullOrEmpty(communication_servers) || String.IsNullOrEmpty(remote_servers) || String.IsNullOrEmpty(update_servers) || String.IsNullOrEmpty(trust_servers) || String.IsNullOrEmpty(tenant_name)|| String.IsNullOrEmpty(location_name))">@Localizer["save"]</MudButton>
            <MudButton OnClick="Download_Configuration" Variant="Variant.Filled" Size="@Size.Small" Color="@Color.Info" Disabled="@(String.IsNullOrEmpty(name) || String.IsNullOrEmpty(communication_servers) || String.IsNullOrEmpty(remote_servers) || String.IsNullOrEmpty(update_servers) || String.IsNullOrEmpty(trust_servers) || String.IsNullOrEmpty(tenant_name)|| String.IsNullOrEmpty(location_name))">@Localizer["download_config"]</MudButton>
        }

    </DialogActions>
</MudDialog>

@code {
    private bool loading_overlay = false;

    [CascadingParameter] IMudDialogInstance MudDialog { get; set; }

    public static List<string> agent_package_configurations_list = new List<string> { };
    public static List<string> tenants_list = new List<string> { };
    public static List<string> locations_list = new List<string> { };

    private string id = String.Empty;
    private string name = String.Empty;
    private bool ssl = false;
    private string package_guid = String.Empty;
    private string communication_servers = String.Empty;
    private string remote_servers = String.Empty;
    private string update_servers = String.Empty;
    private string trust_servers = String.Empty;
    private string file_servers = String.Empty;
    private string tenant_name = String.Empty;
    private string tenant_guid = String.Empty;
    private string tenant_id = String.Empty;
    private string location_name = String.Empty;
    private string location_guid = String.Empty;
    private string location_id = String.Empty;
    private string language = String.Empty;
    private string architecture = "win-x64";

    protected override async Task OnInitializedAsync()
    {
        // Get the current user from the authentication state
        var user = (await AuthenticationStateProvider.GetAuthenticationStateAsync()).User;

        // Check if user is authenticated
        if (user?.Identity is not { IsAuthenticated: true })
        {
            NavigationManager.NavigateTo("/login", true);
            return;
        }

        await Get_Configurations();

        StateHasChanged();
    }

    // Update ports
    private async Task Update_Ports()
    {
        if (ssl)
        {
            if (communication_servers.Contains(":"))
            {
                string[] communication_servers_split = communication_servers.Split(':');

                if (communication_servers_split[1] != "7443")
                    communication_servers = communication_servers_split[0] + ":7443";
            }

            if (remote_servers.Contains(":"))
            {
                string[] remote_servers_split = remote_servers.Split(':');

                if (remote_servers_split[1] != "7443")
                    remote_servers = remote_servers_split[0] + ":7443";
            }

            if (update_servers.Contains(":"))
            {
                string[] update_servers_split = update_servers.Split(':');

                if (update_servers_split[1] != "7443")
                    update_servers = update_servers_split[0] + ":7443";
            }

            if (trust_servers.Contains(":"))
            {
                string[] trust_servers_split = trust_servers.Split(':');

                if (trust_servers_split[1] != "7443")
                    trust_servers = trust_servers_split[0] + ":7443";
            }

            if (file_servers.Contains(":"))
            {
                string[] file_servers_split = file_servers.Split(':');

                if (file_servers_split[1] != "7443")
                    file_servers = file_servers_split[0] + ":7443";
            }
        }
        else
        {
            if (communication_servers.Contains(":"))
            {
                string[] communication_servers_split = communication_servers.Split(':');

                if (communication_servers_split[1] != "7080")
                    communication_servers = communication_servers_split[0] + ":7080";
            }

            if (remote_servers.Contains(":"))
            {
                string[] remote_servers_split = remote_servers.Split(':');

                if (remote_servers_split[1] != "7080")
                    remote_servers = remote_servers_split[0] + ":7080";
            }

            if (update_servers.Contains(":"))
            {
                string[] update_servers_split = update_servers.Split(':');

                if (update_servers_split[1] != "7080")
                    update_servers = update_servers_split[0] + ":7080";
            }

            if (trust_servers.Contains(":"))
            {
                string[] trust_servers_split = trust_servers.Split(':');

                if (trust_servers_split[1] != "7080")
                    trust_servers = trust_servers_split[0] + ":7080";
            }

            if (file_servers.Contains(":"))
            {
                string[] file_servers_split = file_servers.Split(':');

                if (file_servers_split[1] != "7080")
                    file_servers = file_servers_split[0] + ":7080";
            }
        }
    }

    private async Task CleanInput()
    {
        bool protocolRemoved = false;

        if (communication_servers.Contains("http://") || communication_servers.Contains("https://"))
        {
            communication_servers = communication_servers.Replace("http://", "").Replace("https://", "").Trim();
            protocolRemoved = true;
        }
        if (remote_servers.Contains("http://") || remote_servers.Contains("https://"))
        {
            remote_servers = remote_servers.Replace("http://", "").Replace("https://", "").Trim();
            protocolRemoved = true;
        }
        if (update_servers.Contains("http://") || update_servers.Contains("https://"))
        {
            update_servers = update_servers.Replace("http://", "").Replace("https://", "").Trim();
            protocolRemoved = true;
        }
        if (trust_servers.Contains("http://") || trust_servers.Contains("https://"))
        {
            trust_servers = trust_servers.Replace("http://", "").Replace("https://", "").Trim();
            protocolRemoved = true;
        }
        if (file_servers.Contains("http://") || file_servers.Contains("https://"))
        {
            file_servers = file_servers.Replace("http://", "").Replace("https://", "").Trim();
            protocolRemoved = true;
        }

        StateHasChanged();

        if (protocolRemoved)
        {
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;
            Snackbar.Add("Do not include http(s)://. Handle SSL through the SSL checkbox.", Severity.Warning, config => { config.ShowCloseIcon = true; });
        }
    }

    // Get tenants
    private async Task Get_Tenants()
    {
        tenants_list.Clear();

        MySqlConnection conn = new MySqlConnection(Configuration.MySQL.Connection_String);

        try
        {
            await conn.OpenAsync();

            string query = "SELECT * FROM `tenants`;";

            MySqlCommand cmd = new MySqlCommand(query, conn);

            DbDataReader reader = await cmd.ExecuteReaderAsync();

            if (reader.HasRows)
            {
                while (await reader.ReadAsync())
                {
                    tenants_list.Add(reader["name"].ToString() ?? String.Empty);
                }
            }
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("/MainLayout -> Get_Tenants", "Result", ex.ToString());
        }
        finally
        {
            await conn.CloseAsync();
        }
    }

    // Get tenant id from tenants by name
    private async Task Get_Tenant_Id(string tenant_name)
    {
        MySqlConnection conn = new MySqlConnection(Configuration.MySQL.Connection_String);

        try
        {
            await conn.OpenAsync();

            string query = "SELECT * FROM `tenants` WHERE name = @tenant_name;";

            MySqlCommand cmd = new MySqlCommand(query, conn);
            cmd.Parameters.AddWithValue("@tenant_name", tenant_name);

            using (DbDataReader reader = await cmd.ExecuteReaderAsync())
            {
                if (reader.HasRows)
                {
                    while (await reader.ReadAsync())
                    {
                        tenant_id = reader["id"].ToString() ?? String.Empty;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("/MainLayout -> Get_Tenant_Id", "Result", ex.ToString());
        }
        finally
        {
            await conn.CloseAsync();
        }

        // Get Locations for tenant
        await Get_Locations(tenant_id);
    }

    // Get Locations
    private async Task Get_Locations(string tenant_id)
    {
        locations_list.Clear();
        location_name = String.Empty;

        MySqlConnection conn = new MySqlConnection(Configuration.MySQL.Connection_String);

        try
        {
            await conn.OpenAsync();

            string query = "SELECT * FROM `locations` WHERE tenant_id = @tenant_id;";

            MySqlCommand cmd = new MySqlCommand(query, conn);
            cmd.Parameters.AddWithValue("@tenant_id", tenant_id);

            DbDataReader reader = await cmd.ExecuteReaderAsync();

            if (reader.HasRows)
            {
                while (await reader.ReadAsync())
                {
                    locations_list.Add(reader["name"].ToString() ?? String.Empty);
                }
            }
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("/MainLayout -> Get_Locations", "Result", ex.ToString());
        }
        finally
        {
            await conn.CloseAsync();
        }

        StateHasChanged();
    }

    // Get location id from locations by name
    private async Task Get_Location_Id(string location_name)
    {
        MySqlConnection conn = new MySqlConnection(Configuration.MySQL.Connection_String);

        try
        {
            await conn.OpenAsync();

            string query = "SELECT * FROM `locations` WHERE name = @location_name;";

            MySqlCommand cmd = new MySqlCommand(query, conn);
            cmd.Parameters.AddWithValue("@location_name", location_name);

            using (DbDataReader reader = await cmd.ExecuteReaderAsync())
            {
                if (reader.HasRows)
                {
                    while (await reader.ReadAsync())
                    {
                        location_id = reader["id"].ToString() ?? String.Empty;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("/MainLayout -> Get_Location_Id", "Result", ex.ToString());
        }
        finally
        {
            await conn.CloseAsync();
        }
    }

    // Get Configurations
    private async Task Get_Configurations()
    {
        agent_package_configurations_list.Clear();

        MySqlConnection conn = new MySqlConnection(Configuration.MySQL.Connection_String);

        try
        {
            await conn.OpenAsync();

            string query = "SELECT * FROM `agent_package_configurations`;";

            MySqlCommand cmd = new MySqlCommand(query, conn);

            DbDataReader reader = await cmd.ExecuteReaderAsync();

            if (reader.HasRows)
            {
                while (await reader.ReadAsync())
                {
                    agent_package_configurations_list.Add(reader["name"].ToString() ?? String.Empty);
                }
            }
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("/MainLayout -> Get_Configurations", "Result", ex.ToString());
        }
        finally
        {
            await conn.CloseAsync();
        }
    }

    // Get Configuration
    private async Task Get_Configuration(string name)
    {
        tenant_name = String.Empty;
        location_name = String.Empty;

        MySqlConnection conn = new MySqlConnection(Configuration.MySQL.Connection_String);

        string ssl_converted = String.Empty;

        try
        {
            await conn.OpenAsync();

            string query = "SELECT * FROM agent_package_configurations WHERE name = @name;";

            MySqlCommand cmd = new MySqlCommand(query, conn);
            cmd.Parameters.AddWithValue("@name", name);

            Logging.Handler.Debug("Example", "MySQL_Prepared_Query", query);

            using (DbDataReader reader = await cmd.ExecuteReaderAsync())
            {
                if (reader.HasRows)
                {
                    while (await reader.ReadAsync())
                    {
                        id = reader["id"].ToString() ?? String.Empty;
                        name = reader["name"].ToString() ?? String.Empty;
                        communication_servers = reader["communication_servers"].ToString() ?? String.Empty;
                        remote_servers = reader["remote_servers"].ToString() ?? String.Empty;
                        update_servers = reader["update_servers"].ToString() ?? String.Empty;
                        trust_servers = reader["trust_servers"].ToString() ?? String.Empty;
                        file_servers = reader["file_servers"].ToString() ?? String.Empty;
                        tenant_id = reader["tenant_id"].ToString() ?? String.Empty;
                        location_id = reader["location_id"].ToString() ?? String.Empty;
                        language = reader["language"].ToString() ?? String.Empty;
                        ssl = reader["ssl"].ToString() == "1";
                        package_guid = reader["guid"].ToString() ?? String.Empty;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("/MainLayout -> Get_Configurations", "Result", ex.ToString());
        }
        finally
        {
            await conn.CloseAsync();
        }

        await Get_Tenants();
        await Get_Locations(tenant_id); // Get locations for default tenant
        await Get_Guids(); // Get tenant & location guids by id
        await Get_Names(); // Get tenant & location names by id
        
        StateHasChanged();
    }

    // Get tenant & location name by id
    private async Task Get_Names()
    {
        MySqlConnection conn = new MySqlConnection(Configuration.MySQL.Connection_String);

        try
        {
            await conn.OpenAsync();

            string query = "SELECT * FROM `tenants` WHERE id = @tenant_id;";

            MySqlCommand cmd = new MySqlCommand(query, conn);
            cmd.Parameters.AddWithValue("@tenant_id", tenant_id);

            using (DbDataReader reader = await cmd.ExecuteReaderAsync())
            {
                if (reader.HasRows)
                {
                    while (await reader.ReadAsync())
                    {
                        tenant_name = reader["name"].ToString() ?? String.Empty;
                    }
                }
            }

            query = "SELECT * FROM `locations` WHERE id = @location_id;";

            cmd = new MySqlCommand(query, conn);
            cmd.Parameters.AddWithValue("@location_id", location_id);

            using (DbDataReader reader = await cmd.ExecuteReaderAsync())
            {
                if (reader.HasRows)
                {
                    while (await reader.ReadAsync())
                    {
                        location_name = reader["name"].ToString() ?? String.Empty;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("/MainLayout -> Get_Names", "Result", ex.ToString());
        }
        finally
        {
            await conn.CloseAsync();
        }

        StateHasChanged();
    }

    // Get tenant guid & location guid by id
    private async Task Get_Guids()
    {
        MySqlConnection conn = new MySqlConnection(Configuration.MySQL.Connection_String);

        try
        {
            await conn.OpenAsync();

            string query = "SELECT * FROM `tenants` WHERE id = @tenant_id;";

            MySqlCommand cmd = new MySqlCommand(query, conn);
            cmd.Parameters.AddWithValue("@tenant_id", tenant_id);

            using (DbDataReader reader = await cmd.ExecuteReaderAsync())
            {
                if (reader.HasRows)
                {
                    while (await reader.ReadAsync())
                    {
                        tenant_guid = reader["guid"].ToString() ?? String.Empty;
                    }
                }
            }

            query = "SELECT * FROM `locations` WHERE id = @location_id;";

            cmd = new MySqlCommand(query, conn);
            cmd.Parameters.AddWithValue("@location_id", location_id);

            using (DbDataReader reader = await cmd.ExecuteReaderAsync())
            {
                if (reader.HasRows)
                {
                    while (await reader.ReadAsync())
                    {
                        location_guid = reader["guid"].ToString() ?? String.Empty;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("/MainLayout -> Get_Guids", "Result", ex.ToString());
        }
        finally
        {
            await conn.CloseAsync();
        }
    }


    // Update Configuration
    private async Task Update_Configuration()
    {
        Snackbar.Configuration.ShowCloseIcon = true;
        Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;

        MySqlConnection conn = new MySqlConnection(Configuration.MySQL.Connection_String);

        try
        {
            await conn.OpenAsync();

            string query = "UPDATE agent_package_configurations SET `name` = @name, `ssl` = @ssl, communication_servers = @communication_servers, remote_servers = @remote_servers, update_servers = @update_servers, trust_servers = @trust_servers, file_servers = @file_servers, tenant_id = @tenant_id, location_id = @location_id, language = @language WHERE id = @id;";

            MySqlCommand cmd = new MySqlCommand(query, conn);
            cmd.Parameters.AddWithValue("@id", id);
            cmd.Parameters.AddWithValue("@name", name);
            cmd.Parameters.AddWithValue("@communication_servers", communication_servers);
            cmd.Parameters.AddWithValue("@remote_servers", remote_servers);
            cmd.Parameters.AddWithValue("@update_servers", update_servers);
            cmd.Parameters.AddWithValue("@trust_servers", trust_servers);
            cmd.Parameters.AddWithValue("@file_servers", file_servers);
            cmd.Parameters.AddWithValue("@tenant_id", tenant_id);
            cmd.Parameters.AddWithValue("@location_id", location_id);
            cmd.Parameters.AddWithValue("@language", language);
            cmd.Parameters.AddWithValue("@ssl", ssl ? 1 : 0);

            cmd.ExecuteNonQuery();

            this.Snackbar.Add("Configuration saved.", Severity.Success);
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("/MainLayout -> Update_Configuration", "Result", ex.ToString());
        }
        finally
        {
            await conn.CloseAsync();
        }
    }

    // Download Configuration
    private async Task Download_Configuration()
    {
        await Get_Guids();

        try
        {
            // Create the JSON object
            var jsonObject = new
            {
                ssl = ssl,
                package_guid = package_guid,
                communication_servers = communication_servers,
                remote_servers = remote_servers,
                update_servers = update_servers,
                trust_servers = trust_servers,
                file_servers = file_servers,
                tenant_guid = tenant_guid,
                location_guid = location_guid,
                language = language,
                access_key = String.Empty,
                authorized = false,
            };

            // Convert the object into a JSON string
            string json = JsonSerializer.Serialize(jsonObject, new JsonSerializerOptions { WriteIndented = true });
            Logging.Handler.Debug("Online_Mode.Handler.Update_Device_Information", "json", json);

            // Use the JavaScript interop to download the JSON string as a file
            await JSRuntime.InvokeVoidAsync("exportToTxt", "server_config.json", json);
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("/MainLayout -> Download_Configuration", "Result", ex.ToString());
        }
    }

    private async Task Add_Agent_Configuration_Dialog()
    {
        var options = new DialogOptions
            {
                CloseButton = true,
                FullWidth = true,
                MaxWidth = MaxWidth.Small,
                BackgroundClass = "dialog-blurring",
            };

        var result = await this.DialogService.Show<Layout.Agent_Download.Add_Agent_Configuration_Dialog>(string.Empty, options).Result;

        if (result.Canceled)
            return;

        Logging.Handler.Debug("/MainLayout -> Event_Details_Dialog", "Result", result.Data.ToString());

        if (result.Data.ToString() == "success")
            await Get_Configurations();
    }

    //OSSCH_START 2f899714-13a3-44f0-ad1d-3e3ac181a480 //OSSCH_END

    private async Task GetCloudPreset()
    {
        // If cloud, set the default servers
        if (Configuration.Members_Portal.IsCloudEnabled)
        {
            ssl = true;
            communication_servers = Configuration.Web_Console.agentConfigurationConnectionString;
            remote_servers = Configuration.Web_Console.agentConfigurationConnectionString;
            update_servers = Configuration.Web_Console.agentConfigurationConnectionString;
            trust_servers = Configuration.Web_Console.agentConfigurationConnectionString;
            file_servers = Configuration.Web_Console.agentConfigurationConnectionString;
        }
    }

    private async Task Download_Installer_Popup()
    {
        await JSRuntime.InvokeVoidAsync("window.open", installer_url, "_blank");
    }

    private async Task Download_Installation_Script_Windows()
    {
        try
        {
            string scriptContent = $@"# NetLock RMM Agent Installation Script for Windows
# This script downloads and installs the NetLock RMM Agent
$packageUrl = ""{installer_url}""

# Check if the service NetLock_RMM_Agent_Comm exists
$serviceName = ""NetLock_RMM_Agent_Comm""
$service = Get-Service -Name $serviceName -ErrorAction SilentlyContinue

if ($service) {{
    Write-Host ""Service '$serviceName' already exists. Installation will not proceed."" -ForegroundColor Yellow
    exit 0
}}

Write-Host ""Service '$serviceName' not found. Proceeding with installation..."" -ForegroundColor Green

# Package download URL
$tempFolder = ""C:\temp""
$zipFile = ""$tempFolder\NetLock_Agent.zip""
$extractFolder = ""$tempFolder\NetLock_Agent""

# Create temp folder if it doesn't exist
if (-not (Test-Path -Path $tempFolder)) {{
    Write-Host ""Creating folder: $tempFolder"" -ForegroundColor Cyan
    New-Item -ItemType Directory -Path $tempFolder -Force | Out-Null
}}

# Download the ZIP file
Write-Host ""Downloading NetLock RMM Agent package..."" -ForegroundColor Cyan
try {{
    Invoke-WebRequest -Uri $packageUrl -OutFile $zipFile -UseBasicParsing
    Write-Host ""Download completed successfully."" -ForegroundColor Green
}} catch {{
    Write-Host ""Error downloading package: $_"" -ForegroundColor Red
    exit 1
}}

# Unzip the package
Write-Host ""Extracting package to $extractFolder..."" -ForegroundColor Cyan
try {{
    # Remove existing extract folder if it exists
    if (Test-Path -Path $extractFolder) {{
        Remove-Item -Path $extractFolder -Recurse -Force
    }}
    
    Expand-Archive -Path $zipFile -DestinationPath $extractFolder -Force
    Write-Host ""Extraction completed successfully."" -ForegroundColor Green
}} catch {{
    Write-Host ""Error extracting package: $_"" -ForegroundColor Red
    exit 1
}}

# Find and execute the installer
$installerPath = Get-ChildItem -Path $extractFolder -Filter ""NetLock_RMM_Agent_Installer.exe"" -Recurse | Select-Object -First 1

if ($installerPath) {{
    Write-Host ""Running installer: $($installerPath.FullName)"" -ForegroundColor Cyan
    try {{
        Start-Process -FilePath $installerPath.FullName -Wait -NoNewWindow
        Write-Host ""Installation completed successfully."" -ForegroundColor Green
    }} catch {{
        Write-Host ""Error running installer: $_"" -ForegroundColor Red
        exit 1
    }}
}} else {{
    Write-Host ""Installer executable 'NetLock_RMM_Agent_Installer.exe' not found in the extracted package."" -ForegroundColor Red
    exit 1
}}

# Cleanup
Write-Host ""Cleaning up temporary files..."" -ForegroundColor Cyan
try {{
    Remove-Item -Path $zipFile -Force -ErrorAction SilentlyContinue
    Remove-Item -Path $extractFolder -Recurse -Force -ErrorAction SilentlyContinue
    Write-Host ""Cleanup completed."" -ForegroundColor Green
}} catch {{
    Write-Host ""Warning: Could not clean up temporary files."" -ForegroundColor Yellow
}}

Write-Host ""NetLock RMM Agent installation process completed!"" -ForegroundColor Green";

            await JSRuntime.InvokeVoidAsync("exportToTxt", "Install-NetLockAgent.ps1", scriptContent);
            
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;
            Snackbar.Add("Windows installation script downloaded successfully.", Severity.Success, config => { config.ShowCloseIcon = true; });
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("/MainLayout -> Download_Installation_Script_Windows", "Result", ex.ToString());
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;
            Snackbar.Add("Error creating installation script. Please check the logs.", Severity.Error, config => { config.ShowCloseIcon = true; });
        }
    }

    private async Task Download_Installation_Script_Linux()
    {
        try
        {
            string scriptContent = $@"#!/bin/bash
# NetLock RMM Agent Installation Script for Linux
# This script downloads and installs the NetLock RMM Agent

PACKAGE_URL=""{installer_url}""
SERVICE_NAME=""netlock-rmm-agent-comm""

# Check if running as root
if [ ""$EUID"" -ne 0 ]; then
    echo ""Error: This script must be run as root (use sudo)""
    exit 1
fi

# Check if the service already exists
if systemctl list-units --full --all | grep -Fq ""$SERVICE_NAME.service""; then
    echo ""Service '$SERVICE_NAME' already exists. Installation will not proceed.""
    exit 0
fi

echo ""Service '$SERVICE_NAME' not found. Proceeding with installation...""

# Package download settings
TEMP_FOLDER=""/tmp/netlock_agent""
ZIP_FILE=""$TEMP_FOLDER/NetLock_Agent.zip""
EXTRACT_FOLDER=""$TEMP_FOLDER/NetLock_Agent""

# Create temp folder if it doesn't exist
if [ ! -d ""$TEMP_FOLDER"" ]; then
    echo ""Creating folder: $TEMP_FOLDER""
    mkdir -p ""$TEMP_FOLDER""
fi

# Download the ZIP file
echo ""Downloading NetLock RMM Agent package...""
if command -v wget &> /dev/null; then
    wget -q --show-progress ""$PACKAGE_URL"" -O ""$ZIP_FILE""
elif command -v curl &> /dev/null; then
    curl -L ""$PACKAGE_URL"" -o ""$ZIP_FILE""
else
    echo ""Error: Neither wget nor curl is available. Please install one of them.""
    exit 1
fi

if [ $? -eq 0 ]; then
    echo ""Download completed successfully.""
else
    echo ""Error downloading package.""
    exit 1
fi

# Unzip the package
echo ""Extracting package to $EXTRACT_FOLDER...""

# Check if unzip is available
if ! command -v unzip &> /dev/null; then
    echo ""Error: unzip is not installed. Please install unzip first.""
    exit 1
fi

# Remove existing extract folder if it exists
if [ -d ""$EXTRACT_FOLDER"" ]; then
    rm -rf ""$EXTRACT_FOLDER""
fi

unzip -q ""$ZIP_FILE"" -d ""$EXTRACT_FOLDER""

if [ $? -eq 0 ]; then
    echo ""Extraction completed successfully.""
else
    echo ""Error extracting package.""
    exit 1
fi

# Find and execute the installer
INSTALLER_PATH=$(find ""$EXTRACT_FOLDER"" -name ""NetLock_RMM_Agent_Installer"" -type f | head -n 1)

if [ -n ""$INSTALLER_PATH"" ]; then
    echo ""Running installer: $INSTALLER_PATH""
    chmod +x ""$INSTALLER_PATH""
    ""$INSTALLER_PATH""
    
    if [ $? -eq 0 ]; then
        echo ""Installation completed successfully.""
    else
        echo ""Error running installer.""
        exit 1
    fi
else
    echo ""Error: Installer executable 'NetLock_RMM_Agent_Installer' not found in the extracted package.""
    exit 1
fi

# Cleanup
echo ""Cleaning up temporary files...""
rm -f ""$ZIP_FILE""
rm -rf ""$EXTRACT_FOLDER""
echo ""Cleanup completed.""

echo ""NetLock RMM Agent installation process completed!""";

            await JSRuntime.InvokeVoidAsync("exportToTxt", "Install-NetLockAgent.sh", scriptContent);
            
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;
            Snackbar.Add("Linux installation script downloaded successfully.", Severity.Success, config => { config.ShowCloseIcon = true; });
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("/MainLayout -> Download_Installation_Script_Linux", "Result", ex.ToString());
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;
            Snackbar.Add("Error creating installation script. Please check the logs.", Severity.Error, config => { config.ShowCloseIcon = true; });
        }
    }

    private async Task Download_Installation_Script_MacOS()
    {
        try
        {
            string scriptContent = $@"#!/bin/bash
# NetLock RMM Agent Installation Script for macOS
# This script downloads and installs the NetLock RMM Agent

PACKAGE_URL=""{installer_url}""
SERVICE_NAME=""netlock-rmm-agent-comm""

# Check if running as root
if [ ""$EUID"" -ne 0 ]; then
    echo ""Error: This script must be run as root (use sudo)""
    exit 1
fi

# Check if the service already exists (launchd)
if launchctl list | grep -q ""$SERVICE_NAME""; then
    echo ""Service '$SERVICE_NAME' already exists. Installation will not proceed.""
    exit 0
fi

echo ""Service '$SERVICE_NAME' not found. Proceeding with installation...""

# Package download settings
TEMP_FOLDER=""/tmp/netlock_agent""
ZIP_FILE=""$TEMP_FOLDER/NetLock_Agent.zip""
EXTRACT_FOLDER=""$TEMP_FOLDER/NetLock_Agent""

# Create temp folder if it doesn't exist
if [ ! -d ""$TEMP_FOLDER"" ]; then
    echo ""Creating folder: $TEMP_FOLDER""
    mkdir -p ""$TEMP_FOLDER""
fi

# Download the ZIP file
echo ""Downloading NetLock RMM Agent package...""
curl -L ""$PACKAGE_URL"" -o ""$ZIP_FILE""

if [ $? -eq 0 ]; then
    echo ""Download completed successfully.""
else
    echo ""Error downloading package.""
    exit 1
fi

# Unzip the package
echo ""Extracting package to $EXTRACT_FOLDER...""

# Remove existing extract folder if it exists
if [ -d ""$EXTRACT_FOLDER"" ]; then
    rm -rf ""$EXTRACT_FOLDER""
fi

unzip -q ""$ZIP_FILE"" -d ""$EXTRACT_FOLDER""

if [ $? -eq 0 ]; then
    echo ""Extraction completed successfully.""
else
    echo ""Error extracting package.""
    exit 1
fi

# Find and execute the installer
INSTALLER_PATH=$(find ""$EXTRACT_FOLDER"" -name ""NetLock_RMM_Agent_Installer"" -type f | head -n 1)

if [ -n ""$INSTALLER_PATH"" ]; then
    echo ""Running installer: $INSTALLER_PATH""
    chmod +x ""$INSTALLER_PATH""
    ""$INSTALLER_PATH""
    
    if [ $? -eq 0 ]; then
        echo ""Installation completed successfully.""
    else
        echo ""Error running installer.""
        exit 1
    fi
else
    echo ""Error: Installer executable 'NetLock_RMM_Agent_Installer' not found in the extracted package.""
    exit 1
fi

# Cleanup
echo ""Cleaning up temporary files...""
rm -f ""$ZIP_FILE""
rm -rf ""$EXTRACT_FOLDER""
echo ""Cleanup completed.""

echo ""NetLock RMM Agent installation process completed!""";

            await JSRuntime.InvokeVoidAsync("exportToTxt", "Install-NetLockAgent.sh", scriptContent);
            
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;
            Snackbar.Add("macOS installation script downloaded successfully.", Severity.Success, config => { config.ShowCloseIcon = true; });
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("/MainLayout -> Download_Installation_Script_MacOS", "Result", ex.ToString());
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;
            Snackbar.Add("Error creating installation script. Please check the logs.", Severity.Error, config => { config.ShowCloseIcon = true; });
        }
    }

    private void Cancel() => MudDialog.Cancel();
}