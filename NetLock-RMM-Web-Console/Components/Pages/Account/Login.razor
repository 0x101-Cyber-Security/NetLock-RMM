@page "/"
@page "/login"

@using Microsoft.AspNetCore.Components.Authorization;
@using Microsoft.AspNetCore.Authentication;
@using Microsoft.AspNetCore.Authentication.Cookies;
@using System;
@using System.Collections.Generic;
@using System.Linq;
@using System.Net.WebSockets;
@using System.Threading.Tasks;
@using System.Security.Claims;
@using Blazored.LocalStorage;
@using System.Security.Principal;
@using Microsoft.AspNetCore.Identity;
@using MySqlConnector;
@using NetLock_RMM_Web_Console.Classes.Authentication
@using Google.Authenticator;
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using Microsoft.AspNetCore.DataProtection
@using System.Globalization;
@using System.Resources;
@using Microsoft.Extensions.Options
@using Microsoft.AspNetCore.Localization
@using Microsoft.AspNetCore.Builder
@using Microsoft.AspNetCore.Http
@using Microsoft.Extensions.Localization
@using Microsoft.JSInterop

@inject NavigationManager NavigationManager
@inject ILocalStorageService localStorage
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@inject IDataProtectionProvider DataProtectionProvider
@inject IStringLocalizer<Components.Pages.Account.Login> Localizer
@inject IHttpContextAccessor _httpContextAccessor
@inject AuthenticationStateProvider AuthenticationStateProvider

<!-- Local Fonts (GDPR compliant) -->
<link rel="stylesheet" href="fonts/poppins.css">

<style>
    .login-page-wrapper {
        font-family: 'Poppins', sans-serif;
        width: 100vw;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        background: linear-gradient(135deg, hsl(218deg 50% 91%) 0%, hsl(213deg 85% 97%) 100%);
        padding: 2rem;
        flex-direction: column;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 9999;
        user-select: none;
        overflow-y: auto;
    }

    .login-page-wrapper * {
        font-family: 'Poppins', sans-serif;
    }

    .screen-1 {
        background: hsl(213deg 85% 97%);
        padding: 3em 2.5em;
        display: flex;
        flex-direction: column;
        border-radius: 30px;
        box-shadow: 0 0 3em hsl(231deg 62% 94%);
        gap: 2em;
        max-width: 420px;
        width: 100%;
        animation: slideIn 0.6s ease-out;
        position: relative;
    }

    /* Dark Mode Support */
    @@media (prefers-color-scheme: dark) {

        .login-page-wrapper {
            background: linear-gradient(135deg, hsl(0deg 0% 12%) 0%, hsl(0deg 0% 18%) 100%);
        }

        .screen-1 {
            background: hsl(0deg 0% 18%);
            box-shadow: 0 0 3em rgba(0, 0, 0, 0.5);
        }

        .login-title {
            color: hsl(0deg 0% 90%) !important;
        }

        .input-group {
            background: hsl(0deg 0% 22%) !important;
            box-shadow: 0 0 2em rgba(0, 0, 0, 0.4) !important;
            color: hsl(0deg 0% 85%) !important;
        }

        .input-group label {
            color: hsl(0deg 0% 90%) !important;
        }

        .input-group input {
            color: hsl(0deg 0% 95%) !important;
        }

        .input-group input::placeholder {
            color: hsl(0deg 0% 50%) !important;
        }

        .input-wrapper ion-icon,
        .input-wrapper .mud-icon-root {
            color: #910012 !important;
        }

        .show-hide-icon:hover {
            color: #b30015 !important;
        }

        .login-button {
            background: #910012 !important;
            box-shadow: 0 4px 15px rgba(145, 0, 18, 0.4) !important;
        }

        .login-button:hover {
            background: #b30015 !important;
            box-shadow: 0 6px 20px rgba(145, 0, 18, 0.6) !important;
        }

        .sso-button {
            background: hsl(0deg 0% 22%) !important;
            border-color: hsl(0deg 0% 35%) !important;
            color: hsl(0deg 0% 90%) !important;
        }

        .sso-button:hover {
            background: hsl(0deg 0% 26%) !important;
            border-color: #910012 !important;
        }

        .sso-divider {
            color: hsl(0deg 0% 60%) !important;
        }

        .sso-divider::before,
        .sso-divider::after {
            background: hsl(0deg 0% 35%) !important;
        }

        .footer-links {
            color: hsl(0deg 0% 60%) !important;
        }

        .footer-links span:hover {
            color: #910012 !important;
        }

        .error-message {
            background: rgba(145, 0, 18, 0.2) !important;
            color: #ff6b7a !important;
        }

        .qr-code-container {
            background: hsl(0deg 0% 22%) !important;
        }

        .info-text {
            color: hsl(0deg 0% 70%) !important;
        }

        .fun-fact {
            color: hsl(0deg 0% 80%) !important;
        }
    }

    /* Force Dark Mode when MudBlazor is in Dark Mode */

    .mud-theme-dark .login-page-wrapper,
    body.mud-theme-dark .login-page-wrapper {
        background: linear-gradient(135deg, hsl(0deg 0% 12%) 0%, hsl(0deg 0% 18%) 100%);
    }

    .mud-theme-dark .screen-1,
    body.mud-theme-dark .screen-1 {
        background: hsl(0deg 0% 18%);
        box-shadow: 0 0 3em rgba(0, 0, 0, 0.5);
    }

    .mud-theme-dark .login-title,
    body.mud-theme-dark .login-title {
        color: hsl(0deg 0% 90%) !important;
    }

    .mud-theme-dark .input-group,
    body.mud-theme-dark .input-group {
        background: hsl(0deg 0% 22%) !important;
        box-shadow: 0 0 2em rgba(0, 0, 0, 0.4) !important;
        color: hsl(0deg 0% 85%) !important;
    }

    .mud-theme-dark .input-group label,
    body.mud-theme-dark .input-group label {
        color: hsl(0deg 0% 90%) !important;
    }

    .mud-theme-dark .input-group input,
    body.mud-theme-dark .input-group input {
        color: hsl(0deg 0% 95%) !important;
    }

    .mud-theme-dark .input-group input::placeholder,
    body.mud-theme-dark .input-group input::placeholder {
        color: hsl(0deg 0% 50%) !important;
    }

    .mud-theme-dark .input-wrapper ion-icon,
    .mud-theme-dark .input-wrapper .mud-icon-root,
    body.mud-theme-dark .input-wrapper ion-icon,
    body.mud-theme-dark .input-wrapper .mud-icon-root {
        color: #910012 !important;
    }

    .mud-theme-dark .show-hide-icon:hover,
    body.mud-theme-dark .show-hide-icon:hover {
        color: #b30015 !important;
    }

    .mud-theme-dark .login-button,
    body.mud-theme-dark .login-button {
        background: #910012 !important;
        box-shadow: 0 4px 15px rgba(145, 0, 18, 0.4) !important;
    }

    .mud-theme-dark .login-button:hover,
    body.mud-theme-dark .login-button:hover {
        background: #b30015 !important;
        box-shadow: 0 6px 20px rgba(145, 0, 18, 0.6) !important;
    }

    .mud-theme-dark .sso-button,
    body.mud-theme-dark .sso-button {
        background: hsl(0deg 0% 22%) !important;
        border-color: hsl(0deg 0% 35%) !important;
        color: hsl(0deg 0% 90%) !important;
    }

    .mud-theme-dark .sso-button:hover,
    body.mud-theme-dark .sso-button:hover {
        background: hsl(0deg 0% 26%) !important;
        border-color: #910012 !important;
    }

    .mud-theme-dark .sso-divider,
    body.mud-theme-dark .sso-divider {
        color: hsl(0deg 0% 60%) !important;
    }

    .mud-theme-dark .sso-divider::before,
    .mud-theme-dark .sso-divider::after,
    body.mud-theme-dark .sso-divider::before,
    body.mud-theme-dark .sso-divider::after {
        background: hsl(0deg 0% 35%) !important;
    }

    .mud-theme-dark .footer-links,
    body.mud-theme-dark .footer-links {
        color: hsl(0deg 0% 60%) !important;
    }

    .mud-theme-dark .footer-links span:hover,
    body.mud-theme-dark .footer-links span:hover {
        color: #910012 !important;
    }

    .mud-theme-dark .error-message,
    body.mud-theme-dark .error-message {
        background: rgba(145, 0, 18, 0.2) !important;
        color: #ff6b7a !important;
    }

    .mud-theme-dark .qr-code-container,
    body.mud-theme-dark .qr-code-container {
        background: hsl(0deg 0% 22%) !important;
    }

    .mud-theme-dark .info-text,
    body.mud-theme-dark .info-text {
        color: hsl(0deg 0% 70%) !important;
    }

    .mud-theme-dark .fun-fact,
    body.mud-theme-dark .fun-fact {
        color: hsl(0deg 0% 80%) !important;
    }

    .logo-container {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: -2em;
        margin-bottom: 1em;
    }

    .logo-container img {
        width: 200px;
        height: auto;
        filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
    }

    .login-title {
        text-align: center;
        color: hsl(0deg 0% 25%);
        font-size: 1.8em;
        font-weight: 600;
        margin: -1em 0 0.5em 0;
    }

    .input-group {
        background: hsl(0deg 0% 100%);
        box-shadow: 0 0 2em hsl(231deg 62% 94%);
        padding: 1.2em;
        display: flex;
        flex-direction: column;
        gap: 0.5em;
        border-radius: 20px;
        color: hsl(0deg 0% 30%);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .input-group:focus-within {
        transform: translateY(-2px);
        box-shadow: 0 4px 3em rgba(145, 0, 18, 0.15);
    }

    .input-group label {
        font-size: 0.85em;
        font-weight: 500;
        color: hsl(0deg 0% 30%);
        margin-bottom: 0.3em;
    }

    .input-wrapper {
        display: flex;
        align-items: center;
        gap: 0.8em;
    }

    .input-wrapper ion-icon,
    .input-wrapper .mud-icon-root {
        color: #910012;
        font-size: 1.3em;
        flex-shrink: 0;
    }

    .input-group input {
        outline: none;
        border: none;
        background: transparent;
        flex: 1;
        font-size: 0.95em;
        color: hsl(0deg 0% 20%);
    }

    .input-group input::placeholder {
        color: hsl(0deg 0% 60%);
        font-size: 0.9em;
    }

    .show-hide-icon {
        cursor: pointer;
        transition: color 0.2s ease;
    }

    .show-hide-icon:hover {
        color: #b30015;
    }

    .login-button {
        padding: 1em;
        background: #910012;
        color: hsl(0 0 100);
        border: none;
        border-radius: 30px;
        font-weight: 600;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(145, 0, 18, 0.3);
        margin-top: 0.5em;
    }

    .login-button:hover {
        background: #b30015;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(145, 0, 18, 0.4);
    }

    .login-button:active {
        transform: translateY(0);
    }

    .login-button:disabled {
        background: hsl(0deg 0% 70%);
        cursor: not-allowed;
        box-shadow: none;
    }

    .sso-divider {
        display: flex;
        align-items: center;
        gap: 1em;
        margin: 1em 0;
        color: hsl(0deg 0% 50%);
        font-size: 0.85em;
    }

    .sso-divider::before,
    .sso-divider::after {
        content: '';
        flex: 1;
        height: 1px;
        background: hsl(0deg 0% 85%);
    }

    .sso-button {
        background: white;
        border: 2px solid hsl(0deg 0% 90%);
        padding: 0.9em;
        border-radius: 20px;
        font-weight: 500;
        font-size: 0.9em;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 0.8em;
        color: hsl(0deg 0% 30%);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5em;
    }

    .sso-button:hover {
        background: hsl(0deg 0% 98%);
        border-color: #910012;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .footer-links {
        display: flex;
        justify-content: space-between;
        font-size: 0.8em;
        color: hsl(0deg 0% 45%);
        margin-top: 0.5em;
    }

    .footer-links span {
        cursor: pointer;
        transition: color 0.2s ease;
    }

    .footer-links span:hover {
        color: #910012;
    }

    .error-message {
        background: rgba(145, 0, 18, 0.1);
        color: #910012;
        padding: 0.8em;
        border-radius: 15px;
        font-size: 0.85em;
        text-align: center;
        margin-top: 1em;
        animation: shake 0.5s ease;
        border: 1px solid rgba(145, 0, 18, 0.2);
    }

    .qr-code-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 2em;
        background: white;
        border-radius: 20px;
        margin: 1em 0;
    }

    .qr-code-container img {
        width: 200px;
        height: 200px;
        object-fit: contain;
    }

    .info-text {
        font-size: 0.9em;
        color: hsl(0deg 0% 40%);
        text-align: center;
        line-height: 1.6;
        margin: 1em 0;
    }

    .fun-fact {
        text-align: center;
        color: hsl(0deg 0% 30%);
        font-size: 1.1em;
        font-weight: 500;
        margin-top: 2em;
        padding: 0 2em;
        animation: fadeIn 1s ease-in;
    }

    @@keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    @@keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-10px); }
        75% { transform: translateX(10px); }
    }

    .animated-text {
        animation: pulse 2s infinite ease-in-out;
    }

    @@keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.6;
        }
    }

    .wave-emoji {
        display: inline-block;
        animation: wave 2s infinite;
        transform-origin: 70% 70%;
    }

    @@keyframes wave {
        0% { transform: rotate(0deg); }
        15% { transform: rotate(15deg); }
        30% { transform: rotate(-10deg); }
        45% { transform: rotate(15deg); }
        60% { transform: rotate(-10deg); }
        75% { transform: rotate(15deg); }
        100% { transform: rotate(0deg); }
    }

    /* Mobile Responsive */
    @@media (max-width: 768px) {
        .screen-1 {
            padding: 2em 1.5em;
            gap: 1.5em;
        }

        .logo-container img {
            width: 150px;
        }

        .login-title {
            font-size: 1.5em;
        }

        .fun-fact {
            font-size: 0.95em;
            padding: 0 1em;
        }
    }

    /* Hide MudBlazor default components when using custom login */
    .login-page-wrapper .mud-appbar,
    .login-page-wrapper .mud-layout {
        display: none;
    }
</style>

<MudOverlay Visible="@loading_overlay" DarkBackground="false" Absolute="false">
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; gap: 1rem; animation: fadeIn 0.5s ease-in-out;">
        <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" Thickness="6" />
        <MudText Typo="Typo.h5" Class="animated-text">
            Please wait... <span class="wave-emoji">🐧</span>
        </MudText>
    </div>
</MudOverlay>

<AuthorizeView>
    <NotAuthorized>
        <div class="login-page-wrapper">
            <div class="screen-1">
                <div class="logo-container">
                    <img src="media/images/NetLock-RMM-Logo-Transparent.png" alt="NetLock RMM Logo" />
                </div>

                <h2 class="login-title">@(auth_status == 1 ? Localizer["reset_password"] : "Welcome Back")</h2>

                @if (auth_status == 0 && two_factor_state == 0)
                {
                    <!-- Normal Login -->
                    <div class="input-group">
                        <label for="username">@Localizer["username"]</label>
                        <div class="input-wrapper">
                            <ion-icon name="mail-outline"></ion-icon>
                            <input type="text" 
                                   @bind="@username" 
                                   @bind:event="oninput"
                                   @onkeydown="Enter"
                                   placeholder="username@domain.com" />
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="password">@Localizer["password"]</label>
                        <div class="input-wrapper">
                            <ion-icon name="lock-closed-outline"></ion-icon>
                            <input type="@(showPassword ? "text" : "password")" 
                                   @bind="@password" 
                                   @bind:event="oninput"
                                   @onkeydown="Enter"
                                   placeholder="············" />
                            <ion-icon name="@(showPassword ? "eye-off-outline" : "eye-outline")" 
                                     class="show-hide-icon"
                                     @onclick="TogglePasswordVisibility"></ion-icon>
                        </div>
                    </div>

                    <button class="login-button" @onclick="@Authenticate">
                        @Localizer["login"]
                    </button>

                    @if (isSsoEnabled)
                    {
                        <div class="sso-divider">
                            <span>Or sign in with</span>
                        </div>

                        @if (isAzureAdEnabled)
                        {
                            <button class="sso-button" @onclick='() => NavigationManager.NavigateTo("/challenge/azuread", true)'>
                                <ion-icon name="logo-microsoft"></ion-icon> Sign in with Microsoft
                            </button>
                        }

                        @if (isKeycloakEnabled)
                        {
                            <button class="sso-button" @onclick='() => NavigationManager.NavigateTo("/challenge/keycloak", true)'>
                                <ion-icon name="key-outline"></ion-icon> Sign in with Keycloak
                            </button>
                        }

                        @if (isGoogleIdentityEnabled)
                        {
                            <button class="sso-button" @onclick='() => NavigationManager.NavigateTo("/challenge/google", true)'>
                                <ion-icon name="logo-google"></ion-icon> Sign in with Google
                            </button>
                        }

                        @if (isOktaEnabled)
                        {
                            <button class="sso-button" @onclick='() => NavigationManager.NavigateTo("/challenge/okta", true)'>
                                <ion-icon name="shield-checkmark-outline"></ion-icon> Sign in with Okta
                            </button>
                        }

                        @if (isAuth0Enabled)
                        {
                            <button class="sso-button" @onclick='() => NavigationManager.NavigateTo("/challenge/auth0", true)'>
                                <ion-icon name="lock-closed-outline"></ion-icon> Sign in with Auth0
                            </button>
                        }
                    }
                }
                else if (auth_status == 0 && two_factor_state == 1)
                {
                    <!-- 2FA Setup -->
                    <p class="info-text">Two-Factor Authentication has been enabled for your account. Please set it up with your favorite 2FA app.</p>

                    <div class="qr-code-container">
                        <img src="@two_factor_qrCodeImageUrl" alt="QR Code" />
                    </div>

                    <p class="info-text">Scan the QR code with your Authenticator app or enter the following code manually: <strong>@two_factor_manualEntrySetupCode</strong></p>

                    <div class="input-group">
                        <label for="2fa-code">@Localizer["2factor_verification_code"]</label>
                        <div class="input-wrapper">
                            <ion-icon name="keypad-outline"></ion-icon>
                            <input type="text" 
                                   @bind="@two_factor_codeInput" 
                                   @bind:event="oninput"
                                   placeholder="000000" />
                        </div>
                    </div>

                    <button class="login-button" @onclick="@Two_Factor_Authentification_VerifyCode">
                        @Localizer["verificate"]
                    </button>
                }
                else if (auth_status == 0 && two_factor_state == 2)
                {
                    <!-- 2FA Verification -->
                    <p class="info-text">Two-factor authentication code:</p>

                    <div class="input-group">
                        <label for="2fa-code">@Localizer["2factor_verification_code"]</label>
                        <div class="input-wrapper">
                            <ion-icon name="keypad-outline"></ion-icon>
                            <input type="text" 
                                   @bind="@two_factor_codeInput" 
                                   @bind:event="oninput"
                                   @onkeydown="Enter"
                                   placeholder="000000" />
                        </div>
                    </div>

                    <button class="login-button" @onclick="@Authenticate">
                        @Localizer["verificate"]
                    </button>
                }
                else if (auth_status == 1 && two_factor_state == 0)
                {
                    <!-- Reset Password -->
                    <div class="input-group">
                        <label for="new-password">@Localizer["new_password"]</label>
                        <div class="input-wrapper">
                            <ion-icon name="lock-closed-outline"></ion-icon>
                            <input type="@(showPassword ? "text" : "password")" 
                                   @bind="@password_new" 
                                   @bind:event="oninput"
                                   @onkeydown="Enter"
                                   placeholder="············" />
                            <ion-icon name="@(showPassword ? "eye-off-outline" : "eye-outline")" 
                                     class="show-hide-icon"
                                     @onclick="TogglePasswordVisibility"></ion-icon>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="confirm-password">@Localizer["new_password_confirm"]</label>
                        <div class="input-wrapper">
                            <ion-icon name="lock-closed-outline"></ion-icon>
                            <input type="@(showPasswordConfirm ? "text" : "password")" 
                                   @bind="@password_confirm_new" 
                                   @bind:event="oninput"
                                   @onkeydown="Enter"
                                   placeholder="············" />
                            <ion-icon name="@(showPasswordConfirm ? "eye-off-outline" : "eye-outline")" 
                                     class="show-hide-icon"
                                     @onclick="TogglePasswordConfirmVisibility"></ion-icon>
                        </div>
                    </div>

                    <button class="login-button" @onclick="@Reset_Password" disabled="@Check_New_Password()">
                        @Localizer["confirm"]
                    </button>
                }
                else if (auth_status == 2 && two_factor_state == 0)
                {
                    <!-- Login after password reset -->
                    <div class="input-group">
                        <label for="username">@Localizer["username"]</label>
                        <div class="input-wrapper">
                            <ion-icon name="mail-outline"></ion-icon>
                            <input type="text" 
                                   @bind="@username" 
                                   @bind:event="oninput"
                                   @onkeydown="Enter"
                                   placeholder="username@domain.com" />
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="password">@Localizer["password"]</label>
                        <div class="input-wrapper">
                            <ion-icon name="lock-closed-outline"></ion-icon>
                            <input type="@(showPassword ? "text" : "password")" 
                                   @bind="@password" 
                                   @bind:event="oninput"
                                   @onkeydown="Enter"
                                   placeholder="············" />
                            <ion-icon name="@(showPassword ? "eye-off-outline" : "eye-outline")" 
                                     class="show-hide-icon"
                                     @onclick="TogglePasswordVisibility"></ion-icon>
                        </div>
                    </div>

                    <button class="login-button" @onclick="@Authenticate">
                        @Localizer["login"]
                    </button>
                }
                else if (auth_status == 2 && two_factor_state == 1)
                {
                    <!-- Reset password with 2FA setup -->
                    <div class="qr-code-container">
                        <img src="@two_factor_qrCodeImageUrl" alt="@Localizer["2factor_code_image_alt"]" />
                    </div>

                    <p class="info-text">@Localizer["2factor_code_description"]</p>
                    <p class="info-text"><strong>@two_factor_manualEntrySetupCode</strong></p>

                    <div class="input-group">
                        <label for="2fa-code">@Localizer["2factor_verification_code"]</label>
                        <div class="input-wrapper">
                            <ion-icon name="keypad-outline"></ion-icon>
                            <input type="text" 
                                   @bind="@two_factor_codeInput" 
                                   @bind:event="oninput"
                                   placeholder="000000" />
                        </div>
                    </div>

                    <button class="login-button" @onclick="@Two_Factor_Authentification_VerifyCode">
                        @Localizer["verificate"]
                    </button>
                }
                else if (auth_status == 2 && two_factor_state == 2)
                {
                    <!-- Reset password with 2FA verification -->
                    <p class="info-text">@Localizer["2factor_verification_code_long"]</p>

                    <div class="input-group">
                        <label for="2fa-code">@Localizer["2factor_verification_code"]</label>
                        <div class="input-wrapper">
                            <ion-icon name="keypad-outline"></ion-icon>
                            <input type="text" 
                                   @bind="@two_factor_codeInput" 
                                   @bind:event="oninput"
                                   @onkeydown="Enter"
                                   placeholder="000000" />
                        </div>
                    </div>

                    <button class="login-button" @onclick="@Authenticate">
                        @Localizer["verificate"]
                    </button>
                }

                @if (!string.IsNullOrEmpty(message))
                {
                    <div class="error-message">
                        @message
                    </div>
                }

                <div class="footer-links">
                    <span onclick="window.open('https://members.netlockrmm.com/', '_blank')">Support</span>
                    <span onclick="window.open('https://docs.netlockrmm.com/', '_blank')">Documentation</span>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(funFact))
            {
                <p class="fun-fact">"@funFact"</p>
            }
        </div>

        <!-- Ion Icons Script -->
        <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
        <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    </NotAuthorized>
</AuthorizeView>

@code {

    private string netlock_username = String.Empty;
    private bool permissions_dashboard_enabled = false;
    public static List<string> permissions_tenants_list = new List<string> { };
    private bool isSsoEnabled => NetLock_RMM_Web_Console.Configuration.Sso.IsEnabled;
    private bool isAzureAdEnabled => NetLock_RMM_Web_Console.Configuration.Sso.IsAzureAdEnabled;
    private bool isKeycloakEnabled => NetLock_RMM_Web_Console.Configuration.Sso.IsKeycloakEnabled;
    private bool isGoogleIdentityEnabled => NetLock_RMM_Web_Console.Configuration.Sso.isGoogleIdentityEnabled;
    private bool isOktaEnabled => NetLock_RMM_Web_Console.Configuration.Sso.IsOktaEnabled;
    private bool isAuth0Enabled => NetLock_RMM_Web_Console.Configuration.Sso.IsAuth0Enabled;

    private async Task<bool> Permissions()
    {
        try
        {
            bool logout = false;

            // Get the current user from the authentication state
            var user = (await AuthenticationStateProvider.GetAuthenticationStateAsync()).User;

            // Check if user is authenticated
            if (user?.Identity is not { IsAuthenticated: true })
                logout = true;

            netlock_username = user.FindFirst(ClaimTypes.Email)?.Value;

            permissions_dashboard_enabled = await Classes.Authentication.Permissions.Verify_Permission(user.FindFirst(ClaimTypes.Email)?.Value, "dashboard_enabled");
            permissions_tenants_list = await Classes.Authentication.Permissions.Get_Tenants(netlock_username, false);

            if (!permissions_dashboard_enabled)
                logout = true;

            if (logout) // Redirect to the login page
            {
                NavigationManager.NavigateTo("/logout", true);
                return false;
            }

            // Load other permissions here

            // All fine? Nice.
            return true;
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("/dashboard -> Permissions", "Error", ex.ToString());
            return false;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await AfterInitializedAsync();
        }
    }

    private async Task AfterInitializedAsync()
    {
        // Check if user just logged out (to prevent automatic re-login)
        var uri = new Uri(NavigationManager.Uri);
        var justLoggedOut = uri.Query.Contains("logout=true");
        
        if (justLoggedOut)
        {
            Logging.Handler.Debug("/login", "State", "User just logged out, clearing all caches");
            
            // Clear SSO cache explicitly
            if (AuthenticationStateProvider is CustomAuthenticationStateProvider customProvider)
            {
                customProvider.ClearSsoCache();
                Logging.Handler.Debug("/login", "State", "SSO cache cleared");
            }
            
            // Verify user is really logged out
            var user = (await AuthenticationStateProvider.GetAuthenticationStateAsync()).User;
            if (user?.Identity is { IsAuthenticated: true })
            {
                Logging.Handler.Debug("/login", "State", "User still authenticated after logout, forcing full reload");
                // User is still authenticated, force a full page reload to clear everything
                NavigationManager.NavigateTo("/", true);
                return;
            }
            
            Logging.Handler.Debug("/login", "State", "Logout confirmed, clearing URL flag");
            // Clear the logout flag from URL without reload (user is properly logged out)
            NavigationManager.NavigateTo("/", false);
        }
        else
        {
            // Get the current user from the authentication state
            var user = (await AuthenticationStateProvider.GetAuthenticationStateAsync()).User;

            // Check if user is authenticated
            if (user?.Identity is { IsAuthenticated: true })
            {
                Logging.Handler.Debug("/login", "State", "User already authenticated, redirecting to dashboard");
                NavigationManager.NavigateTo("/dashboard", true);
                return;
            }
        }

        loading_overlay = true;
        StateHasChanged();

        funFact = await Classes.Miscellaneous.FunFacts.GetRandomFact();

        loading_overlay = false;
        StateHasChanged();
    }

    private bool loading_overlay = false;

    private string username = String.Empty;
    private string password = String.Empty;
    private string message = String.Empty;
    private string role = String.Empty;
    private bool isPasswordCorrect = false;
    private int auth_status = 0; //0 = not logged in, 1 = logged in, 2 = reset password

    private bool success = false;

    private int reset_password = 0;
    private string password_new = String.Empty;
    private string password_confirm_new = String.Empty;

    // Password visibility toggles
    private bool showPassword = false;
    private bool showPasswordConfirm = false;

    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
    }

    private void TogglePasswordConfirmVisibility()
    {
        showPasswordConfirm = !showPasswordConfirm;
    }

    //2factor
    private TwoFactorAuthenticator tfa = new TwoFactorAuthenticator();

    private int two_factor_enabled = 0;
    private bool two_factor_setup_mode = false;
    private int two_factor_state = 0; //0 = disabled, 1 = setup, 2 = enabled
    private string two_factor_account_secret_key = String.Empty;
    private string two_factor_codeInput = String.Empty;
    private bool two_factor_isCodeVerified = false;
    private string two_factor_qrCodeImageUrl = String.Empty;
    private string two_factor_manualEntrySetupCode = String.Empty;

    private int invalid_count = 0;

    private string funFact = String.Empty;

    private async Task Enter(KeyboardEventArgs e)
    {
        if (e.Code == "Enter" && !String.IsNullOrEmpty(password))
            await Authenticate();
    }

    private async Task Authenticate()
    {
        Logging.Handler.Debug("/login -> Authenticate", "username", username);

        MySqlConnection conn = new MySqlConnection(NetLock_RMM_Web_Console.Configuration.MySQL.Connection_String);

        try
        {
            await conn.OpenAsync();

            MySqlCommand command = new MySqlCommand("SELECT * FROM accounts WHERE username = @username;", conn);
            command.Parameters.AddWithValue("@username", username);

            MySqlDataReader reader = await command.ExecuteReaderAsync();

            if (reader.HasRows)
            {
                while (reader.Read())
                {
                    isPasswordCorrect = BCrypt.Verify(password, reader["password"].ToString());
                    role = reader["role"].ToString() ?? string.Empty;
                    two_factor_enabled = Convert.ToInt32(reader["two_factor_enabled"]);
                    two_factor_account_secret_key = reader["two_factor_account_secret_key"].ToString() ?? string.Empty;
                    reset_password = Convert.ToInt32(reader["reset_password"]);
                }
            }
            else
            {
                invalid_count++;
                message = Localizer["invalid_credentials"] + " (" + invalid_count + ")";
                return;
            }

            await reader.CloseAsync();
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("login", "fehler", ex.ToString());
            return; // Abort if an error occurs
        }
        finally
        {
            await conn.CloseAsync();
        }

        Logging.Handler.Debug("/login -> Authenticate", "isPasswordCorrect", isPasswordCorrect.ToString());
        Logging.Handler.Debug("/login -> Authenticate", "role", role);
        Logging.Handler.Debug("/login -> Authenticate", "two_factor_enabled", two_factor_enabled.ToString());
        Logging.Handler.Debug("/login -> Authenticate", "two_factor_account_secret_key", two_factor_account_secret_key);

        try
        {
            bool user_verified = false;

            if (isPasswordCorrect && reset_password == 1)
            {
                auth_status = 1;
                return;
            }

            if (isPasswordCorrect)
            {
                if (two_factor_enabled == 1)
                {
                    // 2FA is activated
                    if (string.IsNullOrEmpty(two_factor_account_secret_key))
                    {
                        // Key not set, user must go through setup
                        two_factor_account_secret_key = Randomizer.Handler.Key(20);
                        two_factor_setup_mode = true;
                        two_factor_state = 1;
                        await Two_Factor_Authentification_Setup();
                        return;
                    }
                    else
                    {
                        // Key set, user must verify code
                        two_factor_state = 2;
                        await Two_Factor_Authentification_VerifyCode();

                        if (!String.IsNullOrEmpty(two_factor_codeInput))
                        {
                            if (two_factor_isCodeVerified)
                            {
                                user_verified = true;
                                message = String.Empty; // Clear message on successful verification
                            }
                            else
                            {
                                message = Localizer["2factor_invalid_code"];
                                invalid_count++;
                                return; // Abort if the code is incorrect
                            }
                        }
                    }
                }
                else
                {
                    // 2FA is not activated
                    user_verified = true;
                }

                if (user_verified)
                {
                    await Login_User();
                }
            }
            else
            {
                invalid_count++;
                message = Localizer["invalid_credentials"] + " (" + invalid_count + ")";
            }
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("/login Authenticate", "isPasswordCorrect", ex.ToString());
        }
    }


    private async Task Login_User()
    {
        Snackbar.Configuration.ShowCloseIcon = true;
        Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;

        try
        {
            // Get the user's IP addresses
            string ip_address = _httpContextAccessor.HttpContext?.Connection?.RemoteIpAddress?.ToString();

            // Update latest login session
            MySqlConnection conn = new MySqlConnection(NetLock_RMM_Web_Console.Configuration.MySQL.Connection_String);

            try
            {
                await conn.OpenAsync();

                string execute_query = "UPDATE accounts SET last_login = @last_login, ip_address = @ip_address WHERE username = @username;";

                MySqlCommand cmd = new MySqlCommand(execute_query, conn);
                cmd.Parameters.AddWithValue("@username", username);
                cmd.Parameters.AddWithValue("@last_login", DateTime.Now);
                cmd.Parameters.AddWithValue("@ip_address", ip_address);
                cmd.ExecuteNonQuery();

                success = true;
            }
            catch (Exception ex)
            {
                Logging.Handler.Error("Add_Mail_Notification_Dialog", "General error", ex.ToString());
            }
            finally
            {
                await conn.CloseAsync();
            }

            Logging.Handler.Debug("/login -> Login_User", "perform user login", "username: " + username + " role: " + role);

            var customAuthStateProvider = (CustomAuthenticationStateProvider)AuthenticationStateProvider;
            await customAuthStateProvider.UpdateAuthentificationState(new UserSession
                {
                    UserName = username,
                    Role = role
                }, false);

			//Snackbar.Add("Welcome back! :)", Severity.Success);

            await Permissions();

            if (permissions_dashboard_enabled)
                NavigationManager.NavigateTo("/dashboard", true);
            else if (!permissions_dashboard_enabled)
                NavigationManager.NavigateTo("/home", true);
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("/login -> Login_User", "two_factor_account_secret_key", ex.ToString());
        }
    }

    private async Task Two_Factor_Authentification_VerifyCode()
    {
        two_factor_isCodeVerified = tfa.ValidateTwoFactorPIN(two_factor_account_secret_key, two_factor_codeInput);

        if (two_factor_isCodeVerified && two_factor_setup_mode)
        {
            bool success = false;

            MySqlConnection conn = new MySqlConnection(NetLock_RMM_Web_Console.Configuration.MySQL.Connection_String);

            try
            {
                await conn.OpenAsync();

                string execute_query = "UPDATE accounts SET two_factor_account_secret_key = @two_factor_account_secret_key, two_factor_enabled = 1 WHERE username = @username;";

                MySqlCommand cmd = new MySqlCommand(execute_query, conn);
                cmd.Parameters.AddWithValue("@username", username);
                cmd.Parameters.AddWithValue("@two_factor_account_secret_key", two_factor_account_secret_key);

                cmd.ExecuteNonQuery();
                success = true;
            }
            catch (Exception ex)
            {
                Logging.Handler.Error("/login -> ", "Result", ex.ToString());
            }
            finally
            {
                await conn.CloseAsync();
            }

            Logging.Handler.Debug("/login -> Two_Factor_Authentification_VerifyCode", "result", success.ToString());

            if (success)
            {
                // Setze Setup-Mode zurück und melde den Benutzer an
                two_factor_setup_mode = false;
                await Login_User();
            }
        }
        else if (!two_factor_setup_mode && two_factor_isCodeVerified)
        {
            // 2FA-Verifizierung erfolgreich ohne Setup-Modus
            await Login_User();
        }
    }

    private async Task Two_Factor_Authentification_Setup()
    {
        Logging.Handler.Debug("/login -> Two_Factor_Authentification_Setup", "requested for user", "username: " + username + " role: " + role);

        SetupCode setupInfo = tfa.GenerateSetupCode("NetLock RMM - Instance", username, two_factor_account_secret_key, false, 3);
        two_factor_qrCodeImageUrl = setupInfo.QrCodeSetupImageUrl;
        two_factor_manualEntrySetupCode = setupInfo.ManualEntryKey;

        // The code is expected after the setup        
        message = "Please scan the QR code or manually enter the setup code, then enter the verification code.";
    }

    private bool Check_New_Password()
    {
        if (String.IsNullOrEmpty(password_new) || String.IsNullOrEmpty(password_confirm_new)) //passwords missmatch
        {
            message = String.Empty;
            return true;
        }
        else if (password_new != password_confirm_new)
        {
            message = Localizer["passwords_not_match"];
            return true;
        }
        else
        {
            message = String.Empty;
            return false;
        }
    }

    private async Task Reset_Password()
    {
        bool success = false;

        MySqlConnection conn = new MySqlConnection(NetLock_RMM_Web_Console.Configuration.MySQL.Connection_String);

        try
        {
            string new_password = BCrypt.HashPassword(password_new);

            await conn.OpenAsync();

            string execute_query = "UPDATE accounts SET password = @password_new, reset_password = 0 WHERE username = @username;";

            MySqlCommand cmd = new MySqlCommand(execute_query, conn);
            cmd.Parameters.AddWithValue("@username", username);
            cmd.Parameters.AddWithValue("@password_new", new_password);

            cmd.ExecuteNonQuery();
            success = true;

            Logging.Handler.Debug("/login -> Reset_Password", "result", success.ToString());

            //clear password
            password = String.Empty;
            message = String.Empty;
            invalid_count = 0;

            auth_status = 2;

            await Authenticate();
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("/login -> Reset_Password", "Result", ex.ToString());
        }
        finally
        {
            await conn.CloseAsync();
        }
    }
}
