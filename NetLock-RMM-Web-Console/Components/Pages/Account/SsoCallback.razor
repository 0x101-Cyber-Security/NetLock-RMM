@page "/sso-callback"

@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims

@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<style>
    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @@keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.6;
        }
    }

    @@keyframes slide {
        0% {
            transform: translateX(-10px);
        }
        50% {
            transform: translateX(10px);
        }
        100% {
            transform: translateX(-10px);
        }
    }

    .animated-container {
        animation: fadeIn 0.6s ease-in-out;
    }

    .animated-text {
        animation: pulse 2s infinite ease-in-out;
    }

    .slide-emoji {
        display: inline-block;
        animation: slide 2s infinite ease-in-out;
    }

    .sso-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 3rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        max-width: 500px;
        text-align: center;
    }
</style>

<MudOverlay Visible="true" DarkBackground="false" Absolute="false">
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; gap: 2rem;" class="animated-container">
        <div class="sso-card">
            <div style="font-size: 4rem; margin-bottom: 1.5rem;">
                <span class="slide-emoji">üêß</span>
            </div>
            
            <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" Thickness="6" Style="margin-bottom: 1.5rem;" />
            
            <MudText Typo="Typo.h4" Class="animated-text" Style="font-weight: 500; margin-bottom: 0.5rem;">
                SSO Authentication
            </MudText>
            
            <MudText Typo="Typo.body1" Color="Color.Secondary" Style="margin-top: 1rem;">
                Completing your secure login...
            </MudText>
            
            <MudText Typo="Typo.body2" Color="Color.Secondary" Style="margin-top: 0.5rem; font-size: 0.875rem;">
                You'll be redirected shortly
            </MudText>
        </div>
        
        <MudText Typo="Typo.caption" Color="Color.Secondary" Style="opacity: 0.7;">
            Powered by NetLock RMM
        </MudText>
    </div>
</MudOverlay>

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Give the SSO authentication time to complete
                await Task.Delay(500);
            
                // Get the current user from the authentication state
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;

                // Check if user is authenticated
                if (user?.Identity is { IsAuthenticated: true })
                {
                    // User is authenticated via SSO, redirect to dashboard
                    NavigationManager.NavigateTo("/dashboard", true);
                }
                else
                {
                    // Authentication failed, redirect back to login
                    NavigationManager.NavigateTo("/", true);
                }
            }
            catch (Exception e)
            {
                Console.WriteLine(e);
                NavigationManager.NavigateTo("/", true);
            }
        }
    }
}

