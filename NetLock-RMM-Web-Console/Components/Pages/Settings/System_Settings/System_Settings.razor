@page "/system"

@using MySqlConnector;
@using System.Data.Common;
@using System.Text.Json;
@using OfficeOpenXml;
@using System.Xml.Serialization;
@using System.Text;
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage;
@using Microsoft.AspNetCore.DataProtection;

@inject NavigationManager NavigationManager
@inject ILocalStorageService localStorage
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@inject IDataProtectionProvider DataProtectionProvider
@inject IStringLocalizer<Pages.Settings.System_Settings.System_Settings> Localizer

<style>
    .selected-row-light {
        background-color: lightgray;
    }

    .selected-row-dark {
        background-color: #141414;
    }

    .custom-expansion-panel {
        background-color: transparent;
    }

    .dialog-blurring {
        backdrop-filter: blur(10px);
    }

    .mud-table-cell-custom-group {
        font-weight: 500;
    }

    .mud-table-cell-custom-group-footer {
        padding-bottom: 50px;
        text-align: right;
    }

    @@media only screen and (max-width: 768px) {
        .desktop-icon {
            display: none;
        }
    }
</style>

<MudOverlay Visible="@loading_overlay" DarkBackground="false" Absolute="false">
    <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
</MudOverlay>

<AuthorizeView>

    <Authorized>

        @if (permissions_settings_enabled && permissions_settings_system_enabled)
        {
            <MudText Typo="Typo.h5" >System</MudText>

            <MudPaper Elevation="4" Class="mt-5">

                <MudText Class="ml-2" Typo="Typo.h6">@Localizer["MySQL"]</MudText>

                <MudGrid>
                    <!-- MySQL Connection Status -->
                    <MudItem xs="12" sm="4">
                        <MudCard Class="pa-2" Elevation="2">
                            <MudCardContent>
                                @if (mysqlConnectionStatus)
                                {
                                    <div style="display: flex; align-items: center;">
                                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" />
                                        <MudText Class="ml-2" Color="Color.Success">@Localizer["connected"]</MudText>                                    
                                    </div>
                                    
                                    <!-- Additional MySQL Info -->
                                    <MudText Typo="Typo.body2">Version: @mysqlVersion</MudText>
                                    <MudText Typo="Typo.body2">@Localizer["uptime"]: @mysqlUptime (seconds)</MudText>
                                    <MudText Typo="Typo.body2">@Localizer["active connections"]: @mysqlConnectedUsers</MudText>
                                    <MudText Typo="Typo.body2">@Localizer["database size"]: @mysqlDatabaseSize</MudText>

                                    <!-- Security Info -->
                                    <MudText Typo="Typo.body2">@Localizer["max connections"]: @mysqlMaxConnections</MudText>
                                    <MudText Typo="Typo.body2">@Localizer["failed logins"]: @mysqlFailedLogins</MudText>
                                }
                                else
                                {
                                    <div style="display: flex; align-items: center;">
                                        <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Error" />
                                        <MudText Class="ml-2" Color="Color.Error">@Localizer["not connected"]</MudText>
                                    </div>
                                }
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                </MudGrid>

                <MudText Class="mt-3 ml-2" Typo="Typo.h6">@Localizer["active queries"]</MudText>

                <MudTable Height="25vh" FixedHeader="true" FixedFooter="true" Hover="true" RowsPerPage="int.MaxValue" Dense="true" Items="@mysqlActiveQueries" Filter="new Func<MySQL_Active_Queries, bool>(MySQL_Active_Queries_Table_Filter_Func)">
                    <ToolBarContent>
                        <MudTextField Class="mt-0" @bind-Value="mysql_active_queries_table_search_string" Placeholder="@Localizer["search"]" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium"></MudTextField>
                    </ToolBarContent>
                    <HeaderContent>
                        <MudTh @onclick="() => mysql_active_queries_table_sorted_column = (nameof(MySQL_Active_Queries.Id))" style="white-space: nowrap;">Id</MudTh>
                        <MudTh @onclick="() => mysql_active_queries_table_sorted_column = (nameof(MySQL_Active_Queries.User))" style="white-space: nowrap;">User</MudTh>
                        <MudTh @onclick="() => mysql_active_queries_table_sorted_column = (nameof(MySQL_Active_Queries.Host))" style="white-space: nowrap;">Host</MudTh>
                        <MudTh @onclick="() => mysql_active_queries_table_sorted_column = (nameof(MySQL_Active_Queries.Database))" style="white-space: nowrap;">Database</MudTh>
                        <MudTh @onclick="() => mysql_active_queries_table_sorted_column = (nameof(MySQL_Active_Queries.Command))" style="white-space: nowrap;">Command</MudTh>
                        <MudTh @onclick="() => mysql_active_queries_table_sorted_column = (nameof(MySQL_Active_Queries.Time))" style="white-space: nowrap;">Time</MudTh>
                        <MudTh @onclick="() => mysql_active_queries_table_sorted_column = (nameof(MySQL_Active_Queries.State))" style="white-space: nowrap;">State</MudTh>
                        <MudTh @onclick="() => mysql_active_queries_table_sorted_column = (nameof(MySQL_Active_Queries.Info))" style="white-space: nowrap;">Info</MudTh>
                    </HeaderContent>

                    <RowTemplate Context="row">

                        <MudTd DataLabel="Id" @onclick="() => mysql_active_queries_RowClickHandler(row)" class="@mysql_active_queries_GetRowClass(row)" style="white-space: nowrap;">
                            <span style="display: flex; align-items: center;">
                                &nbsp;@row.Id
                            </span>
                        </MudTd>

                        <MudTd DataLabel="User" @onclick="() => mysql_active_queries_RowClickHandler(row)" class="@mysql_active_queries_GetRowClass(row)" style="white-space: nowrap;">
                            <span style="display: flex; align-items: center;">
                                &nbsp;@row.User
                            </span>
                        </MudTd>

                        <MudTd DataLabel="Host" @onclick="() => mysql_active_queries_RowClickHandler(row)" class="@mysql_active_queries_GetRowClass(row)" style="white-space: nowrap;">
                            <span style="display: flex; align-items: center;">
                                &nbsp;@row.Host
                            </span>
                        </MudTd>

                        <MudTd DataLabel="Database" @onclick="() => mysql_active_queries_RowClickHandler(row)" class="@mysql_active_queries_GetRowClass(row)" style="white-space: nowrap;">
                            <span style="display: flex; align-items: center;">
                                &nbsp;@row.Database
                            </span>
                        </MudTd>

                        <MudTd DataLabel="Command" @onclick="() => mysql_active_queries_RowClickHandler(row)" class="@mysql_active_queries_GetRowClass(row)" style="white-space: nowrap;">
                            <span style="display: flex; align-items: center; color: @(GetCommandColor(row.Command, row.Time))">
                                &nbsp;@row.Command
                            </span>
                        </MudTd>

                        <MudTd DataLabel="Time" @onclick="() => mysql_active_queries_RowClickHandler(row)" class="@mysql_active_queries_GetRowClass(row)" style="white-space: nowrap;">
                            <span style="display: flex; align-items: center;">
                                &nbsp;@row.Time
                            </span>
                        </MudTd>

                        <MudTd DataLabel="State" @onclick="() => mysql_active_queries_RowClickHandler(row)" class="@mysql_active_queries_GetRowClass(row)" style="white-space: nowrap;">
                            <span style="display: flex; align-items: center;">
                                &nbsp;@row.State
                            </span>
                        </MudTd>

                          <MudTd DataLabel="Info" @onclick="() => mysql_active_queries_RowClickHandler(row)" class="@mysql_active_queries_GetRowClass(row)" style="white-space: nowrap;">
                            <span style="display: flex; align-items: center;">
                                &nbsp;@row.Info
                            </span>
                        </MudTd>

                    </RowTemplate>
                    <PagerContent>
                        <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100, 250, 500, int.MaxValue }" RowsPerPageString="@Localizer["entries per page"]" />
                    </PagerContent>
                </MudTable>

            </MudPaper>

            <MudPaper Class="mt-3">
                <MudText Class="ml-2" Typo="Typo.h6">@Localizer["Web Console"]</MudText>

                <MudGrid>
                    <!-- CPU Usage -->
                    <MudItem xs="12" sm="4">
                        <MudCard Class="pa-2" Elevation="2">
                            <MudCardContent>
                                <MudText Typo="Typo.subtitle1">@Localizer["cpu usage"]: @cpuUsage%</MudText>
                                <MudProgressLinear Value="@cpuUsage" Color="Color.Primary" />
                            </MudCardContent>
                        </MudCard>
                    </MudItem>

                    <!-- RAM Usage -->
                    <MudItem xs="12" sm="4">
                        <MudCard Class="pa-2" Elevation="2">
                            <MudCardContent>
                                <MudText Typo="Typo.subtitle1">@Localizer["ram usage"]: @ramUsage%</MudText>
                                <MudProgressLinear Value="@ramUsage" Color="Color.Warning" />
                            </MudCardContent>
                        </MudCard>
                    </MudItem>

                    <!-- Disk Usage -->
                    <MudItem xs="12" sm="4">
                        <MudCard Class="pa-2" Elevation="2">
                            <MudCardContent>
                                <MudText Typo="Typo.subtitle1">@Localizer["disk usage"]: @diskUsage%</MudText>
                                <MudProgressLinear Value="@diskUsage" Color="Color.Info" />
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                </MudGrid>
            </MudPaper>

            @foreach (var server in servers)
            {
                DateTime lastHeartbeat;
                bool isRecent = false;

                try
                {
                    // Try to parse the heartbeat timestamp
                    lastHeartbeat = DateTime.Parse(server.hearthbeat);
                    isRecent = (DateTime.Now - lastHeartbeat).TotalMinutes <= 10;
                }
                catch (Exception ex)
                {
                    // Error handling for invalid or missing date
                    Logging.Handler.Error("Heartbeat-Parsing", "Error parsing server heartbeat", ex.ToString());
                }
                
                <MudPaper Class="mt-3">
                    <MudText Class="ml-2" Typo="Typo.h6">@server.name (@server.os)</MudText>
                    <MudText Class="ml-2" Typo="Typo.subtitle2">IP: @server.ip_address | Domain: @server.domain</MudText>

                    <MudText Class="ml-2" Typo="Typo.subtitle2" Color="@(isRecent ? Color.Success : Color.Error)">@Localizer["last hearthbeat"]: @server.hearthbeat</MudText>

                    <MudGrid>
                        <!-- CPU Usage -->
                        <MudItem xs="12" sm="4">
                            <MudCard Class="pa-2" Elevation="2">
                                <MudCardContent>
                                    <MudText Typo="Typo.subtitle1">@Localizer["cpu usage"]: @server.cpu_usage%</MudText>
                                    <MudProgressLinear Value="@Convert.ToDouble(server.cpu_usage)" Color="Color.Primary" />
                                </MudCardContent>
                            </MudCard>
                        </MudItem>

                        <!-- RAM Usage -->
                        <MudItem xs="12" sm="4">
                            <MudCard Class="pa-2" Elevation="2">
                                <MudCardContent>
                                    <MudText Typo="Typo.subtitle1">@Localizer["ram usage"]: @server.ram_usage%</MudText>
                                    <MudProgressLinear Value="@Convert.ToDouble(server.ram_usage)" Color="Color.Warning" />
                                </MudCardContent>
                            </MudCard>
                        </MudItem>

                        <!-- Disk Usage -->
                        <MudItem xs="12" sm="4">
                            <MudCard Class="pa-2" Elevation="2">
                                <MudCardContent>
                                    <MudText Typo="Typo.subtitle1">@Localizer["disk usage"]: @server.disk_usage%</MudText>
                                    <MudProgressLinear Value="@Convert.ToDouble(server.disk_usage)" Color="Color.Info" />
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    </MudGrid>

                    <MudExpansionPanel>
                        <TitleContent>
                            <div class="d-flex">
                                <MudIcon Icon="@Icons.Material.Filled.SettingsApplications" class="mr-3"></MudIcon>
                                <MudText>@Localizer["appsettings.json"]</MudText>
                            </div>
                        </TitleContent>

                        <ChildContent>
                            <MudTextField Class="ml-2 mr-2" T="string" Lines="20" Variant="Variant.Text" ReadOnly="true" @bind-Text="server.appsettings" />
                        </ChildContent>

                    </MudExpansionPanel>
                </MudPaper>
            }

            <!-- NetLock RMM File Server Status -->
                    
             <MudPaper Class="mt-3">
                <MudText Class="ml-2" Typo="Typo.h6">@Localizer["NetLock RMM File Server"] (@Configuration.File_Server.Connection_String)</MudText>

                <MudGrid>
                    <MudItem xs="12" sm="4">
                        <MudCard Class="pa-2" Elevation="2">
                            <MudCardContent>

                                <div style="display: flex; align-items: center;">
                                    @if (fileServerConnectionStatus)
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" />
                                        <MudText Class="ml-2" Color="Color.Success">@Localizer["connected"]</MudText>
                                    }
                                    else
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Error" />
                                        <MudText Class="ml-2" Color="Color.Error">@Localizer["not connected"]</MudText>
                                    }
                                </div>

                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                </MudGrid>

            </MudPaper>

            <MudPaper Class="mt-3">
                <MudText Class="ml-2" Typo="Typo.h6">@Localizer["NetLock RMM Remote Server"] (@Configuration.Remote_Server.Connection_String)</MudText>

                <MudGrid>
                    <!-- Remote Server Connection Status -->
                    <MudItem xs="12" sm="4">
                        <MudCard Class="pa-2" Elevation="2">
                            <MudCardContent>

                                <div style="display: flex; align-items: center;">

                                    @if (remoteServerConnectionStatus)
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" />
                                        <MudText Class="ml-2" Color="Color.Success">@Localizer["connected"]</MudText>
                                    }
                                    else
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Error" />
                                        <MudText Class="ml-2" Color="Color.Error">@Localizer["not connected"]</MudText>
                                    }

                                </div>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                </MudGrid>

            </MudPaper>

            <MudPaper Class="mt-5">
                <MudText Class="ml-2" Typo="Typo.h6">@Localizer["Package Provider URL"]</MudText>
                <MudTextField Class="ml-2 mr-2" T="string" Variant="Variant.Text" @bind-Text="package_url" />
                <MudButton Class="mt-2 ml-2 mb-2" Size="Size.Small" Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.Save" OnClick="Save_Package_Provider_URL" >@Localizer["save"]</MudButton>
            </MudPaper>
        }

    </Authorized>

</AuthorizeView>

@code {

    #region Permissions System

    private string permissions_json = String.Empty;
    private string permissions_tenants_json = String.Empty;
    public static List<string> permissions_tenants_list = new List<string> { };

    private bool permissions_settings_enabled = false;
    private bool permissions_settings_system_enabled = false;

    public class Permissions_Tenants_Activation_State
    {
        public string id { get; set; } = String.Empty;
    }

    private async Task Get_Permissions()
    {
        //Extract user info from users session storage
        var sessionStorage = new ProtectedSessionStorage(JSRuntime, DataProtectionProvider);
        var username = await sessionStorage.GetAsync<string>("username");
        var password = await sessionStorage.GetAsync<string>("password");

        Logging.Handler.Debug("/manage_notifications -> Permissions_Load", "username", username.Value ?? String.Empty);

        //if user info empty, force logout
        if (String.IsNullOrEmpty(username.Value) || String.IsNullOrEmpty(password.Value))
        {
            Logging.Handler.Debug("/manage_notifications -> Permissions_Load", "sessions storage data", "empty, force logout");

            NavigationManager.NavigateTo("/logout", true);
            return;
        }

        //Check if user info is valid, if not, force logout
        if (!await Classes.Authentication.User.Verify_User(username.Value ?? String.Empty, password.Value ?? String.Empty))
        {
            Logging.Handler.Debug("/manage_notifications -> Permissions_Load", "verify user", "incorrect data, force logout");

            NavigationManager.NavigateTo("/logout", true);
            return;
        }

        //Get permissions
        string query = "SELECT * FROM `accounts` WHERE username = @username;";

        MySqlConnection conn = new MySqlConnection(Configuration.MySQL.Connection_String);

        try
        {
            await conn.OpenAsync();

            MySqlCommand command = new MySqlCommand(query, conn);
            command.Parameters.AddWithValue("@username", username.Value);

            Logging.Handler.Debug("/manage_notifications -> Permissions_Load", "query", query);

            using (DbDataReader reader = await command.ExecuteReaderAsync())
            {
                if (reader.HasRows)
                {
                    while (await reader.ReadAsync())
                    {
                        permissions_json = reader["permissions"].ToString() ?? String.Empty;
                        permissions_tenants_json = reader["tenants"].ToString() ?? String.Empty;
                    }
                }
            }

            Logging.Handler.Debug("/manage_notifications -> Permissions_Load", "permissions_json", permissions_json);

            //Extract permissions
            if (!String.IsNullOrEmpty(permissions_json))
            {
                using (JsonDocument document = JsonDocument.Parse(permissions_json))
                {
                    //settings_enabled
                    try
                    {
                        JsonElement element = document.RootElement.GetProperty("settings_enabled");
                        permissions_settings_enabled = element.GetBoolean();
                    }
                    catch (Exception ex)
                    {
                        Logging.Handler.Error("/manage_notifications -> Permissions_Load", "permissions_json (permissions_settings_enabled)", ex.ToString());
                    }

                    //settings_system_enabled
                    try
                    {
                        JsonElement element = document.RootElement.GetProperty("settings_system_enabled");
                        permissions_settings_system_enabled = element.GetBoolean();
                    }
                    catch (Exception ex)
                    {
                        Logging.Handler.Error("/manage_notifications -> Permissions_Load", "permissions_json (settings_system_enabled)", ex.ToString());
                    }
                }
            }
            else if (permissions_json == "[]")
            {
                Logging.Handler.Debug("/manage_notifications -> Permissions_Load", "permissions_json", "Empty, logout user");
                NavigationManager.NavigateTo("/logout", true);
            }
            else
            {
                Logging.Handler.Debug("/manage_notifications -> Permissions_Load", "permissions_json", "Empty, logout user");
                NavigationManager.NavigateTo("/logout", true);
            }

            //Extract tenants from json
            permissions_tenants_list.Clear();
            if (!String.IsNullOrEmpty(permissions_tenants_json))
            {
                //Set the activation state for the tenants
                try
                {
                    List<Permissions_Tenants_Activation_State> tenants_activation_state_list = JsonSerializer.Deserialize<List<Permissions_Tenants_Activation_State>>(permissions_tenants_json);

                    foreach (var tenant in tenants_activation_state_list)
                    {
                        Logging.Handler.Debug("/manage_notifications -> Permissions_Load", "foreach tenant", tenant.id);

                        permissions_tenants_list.Add(tenant.id);
                    }
                }
                catch (Exception ex)
                {
                    Logging.Handler.Error("/manage_notifications -> Permissions_Load (permissions_tenants_json deserialize)", "Result", ex.Message);
                }
            }
            else
            {
                Logging.Handler.Debug("/manage_notifications -> Permissions_Load (permissions_tenants_json deserialize)", "Result", "Empty");
            }
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("/manage_notifications -> Permissions_Load", "general_error (force logout)", ex.Message);
            NavigationManager.NavigateTo("/logout", true);
        }
        finally
        {
            conn.Close();
        }
    }

    #endregion

    private bool loading_overlay = false;

    private bool _isDarkMode = false;

    protected override async Task OnInitializedAsync()
    {
        loading_overlay = true;

        await base.OnInitializedAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await AfterInitializedAsync();
        }
    }

    private async Task AfterInitializedAsync()
    {
        await Get_Permissions();

        _isDarkMode = await JSRuntime.InvokeAsync<bool>("isDarkMode");

        await MySQL_Status();
        await Get_Servers();
        await Get_Package_Provider_URL();

        // Get CPU Usage
        cpuUsage = await Classes.System_Information.Handler.Get_CPU_Usage();

        // Get RAM Usage
        ramUsage = await Classes.System_Information.Handler.Get_RAM_Usage();

        // Get Disk Usage
        diskUsage = await Classes.System_Information.Handler.Get_Disk_Usage();

        fileServerConnectionStatus = await Classes.Helper.Networking.Test_Connection(Configuration.File_Server.Connection_String + "/test");

        remoteServerConnectionStatus = await Classes.Helper.Networking.Test_Connection(Configuration.Remote_Server.Connection_String + "/test");

        loading_overlay = false;

        StateHasChanged();
    }

    private bool mysqlConnectionStatus = false;
    private bool fileServerConnectionStatus = false;
    private bool remoteServerConnectionStatus = false;

    private int cpuUsage = 0;
    private int ramUsage = 0;
    private int diskUsage = 0;

    private string package_url = String.Empty;

    private string mysqlVersion = String.Empty;
    private string mysqlUptime = String.Empty;
    private string mysqlConnectedUsers = String.Empty;
    private string mysqlDatabaseSize = String.Empty;
    private List<MySQL_Active_Queries> mysqlActiveQueries = new List<MySQL_Active_Queries>();
    private bool mysqlSSLEnabled = false;
    private string mysqlFailedLogins = String.Empty;
    private string mysqlPrivilegedUsers = String.Empty;
    private string mysqlMaxConnections = String.Empty;

    public class MySQL_Active_Queries
    {
        public int Id { get; set; }
        public string User { get; set; }
        public string Host { get; set; }
        public string Database { get; set; }
        public string Command { get; set; }
        public int Time { get; set; }
        public string State { get; set; }
        public string Info { get; set; }
    }

    private bool MySQL_Active_Queries_Table_Filter_Func(MySQL_Active_Queries row)
    {
        try
        {
            if (row == null) return false; // Überprüfe, ob row null ist

            if (string.IsNullOrEmpty(mysql_active_queries_table_search_string))
                return true;

            return row.Id.ToString().Contains(mysql_active_queries_table_search_string, StringComparison.OrdinalIgnoreCase) ||
                   (row.User?.Contains(mysql_active_queries_table_search_string, StringComparison.OrdinalIgnoreCase) ?? false) ||
                   (row.Host?.Contains(mysql_active_queries_table_search_string, StringComparison.OrdinalIgnoreCase) ?? false) ||
                   (row.Database?.Contains(mysql_active_queries_table_search_string, StringComparison.OrdinalIgnoreCase) ?? false) ||
                   (row.Command?.Contains(mysql_active_queries_table_search_string, StringComparison.OrdinalIgnoreCase) ?? false) ||
                   row.Time.ToString().Contains(mysql_active_queries_table_search_string, StringComparison.OrdinalIgnoreCase) ||
                   (row.State?.Contains(mysql_active_queries_table_search_string, StringComparison.OrdinalIgnoreCase) ?? false) ||
                   (row.Info?.Contains(mysql_active_queries_table_search_string, StringComparison.OrdinalIgnoreCase) ?? false);
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("/system -> MySQL_Active_Queries_Table_Filter_Func", "general_error", ex.ToString());
            return false;
        }
    }

    private string mysql_active_queries_table_sorted_column;
    private string mysql_active_queries_table_search_string = String.Empty;
    private string mysql_active_queries_selectedRowContent = ""; // Saving content of selected row

    // Executes on row click
    private void mysql_active_queries_RowClickHandler(MySQL_Active_Queries row)
    {
        mysql_active_queries_selectedRowContent = row.Id.ToString();
    }

    private string mysql_active_queries_GetRowClass(MySQL_Active_Queries row)
    {
        return row.Id.ToString() == mysql_active_queries_selectedRowContent ? "selected-row" : "";
    }

    // MySQL

    private string GetCommandColor(string command, int time)
    {
        switch (command)
        {
            case "Daemon":
                return "blue"; 
            case "Sleep":
                return "orange";
            case "Query":
                return time > 60 ? "red" : "green"; // Red for long queries, green for short
            default:
                return "inherit"; // Standard colour
        }
    }

    private async Task MySQL_Status()
    {
        try
        {
            if (await Classes.MySQL.Database.Check_Connection())
            {
                mysqlConnectionStatus = true;

                // Get MySQL Version
                mysqlVersion = await Classes.MySQL.Database.Get_Version();

                // Get MySQL Uptime
                mysqlUptime = await Classes.MySQL.Database.Get_Uptime();

                // Get MySQL Connected Users
                mysqlConnectedUsers = await Classes.MySQL.Database.Get_Connected_Users();

                // Get MySQL Active Queries
                string mysqlActiveQueriesJson = await Classes.MySQL.Database.Get_Active_Queries();
                Logging.Handler.Debug("/system -> MySQL_Status", "mysqlActiveQueriesJson", mysqlActiveQueriesJson);
                mysqlActiveQueries = JsonSerializer.Deserialize<List<MySQL_Active_Queries>>(mysqlActiveQueriesJson);

                // Get MySQL Failed Logins
                mysqlFailedLogins = await Classes.MySQL.Database.Get_Failed_Logins();

                // Get MySQL Max Connections
                mysqlMaxConnections = await Classes.MySQL.Database.Get_Max_Connections();

                // Get MySQL Database Size
                mysqlDatabaseSize = await Classes.MySQL.Database.Get_Database_Size();
            }
            else
            {
                mysqlConnectionStatus = false;
            }
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("/system -> MySQL_Status", "general_error", ex.ToString());
        }

    }

    // Servers overview
    private List<Servers> servers = new List<Servers>();

    public class Servers
    {
        public string id { get; set; }
        public string name { get; set; }
        public string ip_address { get; set; }
        public string domain { get; set; }
        public string os { get; set; }
        public string hearthbeat { get; set; }
        public string appsettings { get; set; }
        public string cpu_usage { get; set; }
        public string ram_usage { get; set; }
        public string disk_usage { get; set; }
    }

    // Get servers from database
    private async Task Get_Servers()
    {
        servers.Clear();

        MySqlConnection conn = new MySqlConnection(Configuration.MySQL.Connection_String);

        try
        {
            await conn.OpenAsync();

            MySqlCommand command = new MySqlCommand("SELECT * FROM servers;", conn);
            using (DbDataReader reader = await command.ExecuteReaderAsync())
            {
                if (reader.HasRows)
                {
                    while (await reader.ReadAsync())
                    {
                        servers.Add(new Servers
                        {
                            id = reader["id"].ToString() ?? String.Empty,
                            name = reader["name"].ToString() ?? String.Empty,
                            ip_address = reader["ip_address"].ToString() ?? String.Empty,
                            domain = reader["domain"].ToString() ?? String.Empty,
                            os = reader["os"].ToString() ?? String.Empty,
                            hearthbeat = reader["hearthbeat"].ToString() ?? String.Empty,
                            appsettings = reader["appsettings"].ToString() ?? String.Empty,
                            cpu_usage = reader["cpu_usage"].ToString() ?? String.Empty,
                            ram_usage = reader["ram_usage"].ToString() ?? String.Empty,
                            disk_usage = reader["disk_usage"].ToString() ?? String.Empty
                        });
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("/system -> Get_Servers", "general_error", ex.ToString());
        }
        finally
        {
            conn.Close();
        }
    }

    // Get package provider URL
    private async Task Get_Package_Provider_URL()
    {
        MySqlConnection conn = new MySqlConnection(Configuration.MySQL.Connection_String);

        try
        {
            await conn.OpenAsync();

            MySqlCommand command = new MySqlCommand("SELECT * FROM settings;", conn);
            using (DbDataReader reader = await command.ExecuteReaderAsync())
            {
                if (reader.HasRows)
                {
                    while (await reader.ReadAsync())
                    {
                        package_url = reader["package_provider_url"].ToString() ?? String.Empty;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("/system -> Get_Package_Provider_URL", "general_error", ex.ToString());
        }
        finally
        {
            conn.Close();
        }
    }

    // Save package provider URL to settings table
    private async Task Save_Package_Provider_URL()
    {
        Snackbar.Configuration.ShowCloseIcon = true;
        Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;

        MySqlConnection conn = new MySqlConnection(Configuration.MySQL.Connection_String);

        try
        {
            await conn.OpenAsync();

            MySqlCommand command = new MySqlCommand("UPDATE settings SET package_provider_url = @package_provider_url;", conn);
            command.Parameters.AddWithValue("@package_provider_url", package_url);

            await command.ExecuteNonQueryAsync();

            Snackbar.Add(Localizer["saved"], Severity.Success);
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("/system -> Save_Package_Provider_URL", "general_error", ex.ToString());
        }
        finally
        {
            conn.Close();
        }
    }

}
